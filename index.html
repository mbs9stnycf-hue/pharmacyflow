<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --nhs-deep-blue: #003087;
            --nhs-blue: #005EB8;
            --nhs-light-blue: #0072CE;
            --nhs-green: #009639;
            --nhs-green-light: #00B84A;
            --nhs-red: #DA291C;
            --nhs-amber: #FAE100;
            --nhs-bg: #F0F4F8;
            --nhs-dark-bg: #001E50;
            --nhs-dark-card: #002A5C;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.96); }
            to   { opacity: 1; transform: scale(1); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 0 3px rgba(0,184,74,0.2); }
            50%       { box-shadow: 0 0 0 6px rgba(0,184,74,0.08); }
        }

        .animate-fadeIn  { animation: fadeIn  0.35s ease-out; }
        .animate-scaleIn { animation: scaleIn 0.25s ease-out; }
        .animate-slideUp { animation: slideUp 0.4s ease-out; }

        .glass {
            background: rgba(240,244,248,0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(0,94,184,0.12);
            box-shadow: 0 8px 32px rgba(0,48,135,0.09);
        }
        .glass-dark {
            background: rgba(0,42,92,0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(0,94,184,0.22);
            box-shadow: 0 8px 32px rgba(0,0,0,0.32);
        }

        .btn-primary {
            background: linear-gradient(135deg, #003087 0%, #005EB8 100%);
            color: white;
            transition: all 0.25s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(0,48,135,0.28);
        }
        .btn-primary:active { transform: translateY(0); }

        .btn-success {
            background: linear-gradient(135deg, #009639 0%, #00B84A 100%);
            color: white;
            transition: all 0.25s ease;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(0,150,57,0.28);
        }

        .btn-outline {
            border: 2px solid #005EB8;
            color: #005EB8;
            background: transparent;
            transition: all 0.25s ease;
        }
        .btn-outline:hover {
            background: #005EB8;
            color: white;
        }

        .input-field {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1.5px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
            color: #111827;
        }
        .input-field:focus {
            outline: none;
            border-color: #005EB8;
            box-shadow: 0 0 0 3px rgba(0,94,184,0.15);
        }
        .dark .input-field {
            background: #1F2937;
            border-color: #374151;
            color: #F9FAFB;
        }
        .dark .input-field:focus {
            border-color: #60A5FA;
            box-shadow: 0 0 0 3px rgba(96,165,250,0.15);
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 16px rgba(0,48,135,0.08);
            border: 1px solid rgba(0,94,184,0.07);
        }
        .dark .card {
            background: #002A5C;
            border-color: rgba(0,94,184,0.2);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect } = React;

    // ─── STORAGE ───────────────────────────────────────────────────────────────
    const Storage = {
        get:    (k)    => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
        set:    (k, v) => localStorage.setItem(k, JSON.stringify(v)),
        remove: (k)    => localStorage.removeItem(k)
    };

    // ─── SVG ICONS ─────────────────────────────────────────────────────────────
    const Icon = {
        Eye: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        ),
        EyeOff: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
            </svg>
        ),
        Sun: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
            </svg>
        ),
        Moon: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        ),
        Back: () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        ),
        Check: () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        ),
        Shield: () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
        ),
        Pill: () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2v-4M9 21H5a2 2 0 01-2-2v-4m0 0h18" />
            </svg>
        ),
        Building: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        ),
        Users: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        ),
        Home: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        ),
        Tasks: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
        ),
        Messages: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        ),
        More: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
        ),
        Handover: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
            </svg>
        ),
        Schedule: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        ),
        SOPs: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        ),
        Calendar: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        ),
        Notices: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
            </svg>
        ),
        Staff: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        ),
        Insights: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        ),
        Settings: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        ),
        Reminders: () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
        ),
    };

    // ─── PASSWORD STRENGTH ─────────────────────────────────────────────────────
    const checkPasswordStrength = (password) => {
        if (!password) return { strength: 'none', score: 0, color: '#9CA3AF', message: '' };
        let score = 0;
        const missing = [];
        if (password.length >= 8)   score += 25; else missing.push('8+ characters');
        if (/[a-z]/.test(password)) score += 25; else missing.push('lowercase letter');
        if (/[A-Z]/.test(password)) score += 25; else missing.push('uppercase letter');
        if (/[0-9]/.test(password)) score += 25; else missing.push('number');
        let strength = 'weak',  color = '#DA291C';
        if (score >= 100) { strength = 'strong'; color = '#009639'; }
        else if (score >= 50) { strength = 'medium'; color = '#FAE100'; }
        return {
            strength, score, color,
            message: missing.length ? `Need: ${missing.join(', ')}` : 'Great password!',
            isValid: score >= 100
        };
    };

    // ─── PRIVACY POLICY MODAL ──────────────────────────────────────────────────
    function PrivacyPolicyModal({ onAccept, onDecline }) {
        return (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 overflow-y-auto">
                <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-scaleIn">
                    <div className="sticky top-0 z-10 rounded-t-2xl p-6" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-white">
                                <Icon.Shield />
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-white">Privacy Policy & Terms of Use</h2>
                                <p className="text-blue-100 text-sm">Please read carefully before using this app</p>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        <section>
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">What Data We Store</h3>
                            <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 space-y-3 text-sm">
                                <div>
                                    <p className="font-semibold text-green-700 dark:text-green-400 mb-1">✓ We Store:</p>
                                    <ul className="list-disc ml-5 text-gray-700 dark:text-gray-300 space-y-1">
                                        <li>Your name and role within the pharmacy</li>
                                        <li>Tasks assigned to you and completion records</li>
                                        <li>Messages you send to your team</li>
                                        <li>Your work schedule and shift information</li>
                                        <li>Handover notes and SOPs you create</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold text-red-700 dark:text-red-400 mb-1">✗ We Do NOT Store:</p>
                                    <ul className="list-disc ml-5 text-gray-700 dark:text-gray-300 space-y-1">
                                        <li>Patient names, addresses, or contact details</li>
                                        <li>NHS numbers or medical records</li>
                                        <li>Prescription details or medication information</li>
                                        <li>Any personal financial information</li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">Important Notice</h3>
                            <div className="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-4 text-sm text-amber-800 dark:text-amber-300">
                                <p className="font-semibold mb-1">⚠ Do Not Enter Patient Data</p>
                                <p>This app is for internal pharmacy team use only. Never enter patient names, NHS numbers, prescriptions, or any patient-identifiable information into this system.</p>
                            </div>
                        </section>

                        <section>
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">Data Storage</h3>
                            <p className="text-sm text-gray-600 dark:text-gray-400">All data is stored locally in your browser using localStorage. No data is sent to any external server. Data is only accessible on the device you use to log in.</p>
                        </section>

                        <section>
                            <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">Your Agreement</h3>
                            <p className="text-sm text-gray-600 dark:text-gray-400">By accepting, you agree to use this app responsibly, not to enter any patient-identifiable information, and to keep your login credentials secure.</p>
                        </section>
                    </div>

                    <div className="sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 flex gap-3 rounded-b-2xl">
                        <button onClick={onDecline} className="flex-1 py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Decline
                        </button>
                        <button onClick={onAccept} className="flex-1 py-3 rounded-xl btn-primary font-semibold">
                            I Accept & Agree
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // ─── AUTH SCREEN ───────────────────────────────────────────────────────────
    function AuthScreen({ onLogin, darkMode, setDarkMode }) {
        const [mode, setMode] = useState('login'); // 'login' | 'signup' | 'forgot'
        const [name, setName] = useState('');
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [rememberMe, setRememberMe] = useState(false);
        const [showPassword, setShowPassword] = useState(false);
        const [showConfirm, setShowConfirm] = useState(false);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const [showPrivacy, setShowPrivacy] = useState(false);
        const [pendingSignup, setPendingSignup] = useState(null);
        const [pwStrength, setPwStrength] = useState({ strength: 'none', score: 0 });

        // Forgot password states
        const [forgotStep, setForgotStep] = useState(1); // 1: email+branch, 2: new password, 3: success
        const [resetEmail, setResetEmail] = useState('');
        const [resetBranchId, setResetBranchId] = useState('');
        const [resetPassword, setResetPassword] = useState('');
        const [resetConfirm, setResetConfirm] = useState('');
        const [resetError, setResetError] = useState('');
        const [showResetPw, setShowResetPw] = useState(false);

        useEffect(() => {
            if (mode === 'signup') setPwStrength(checkPasswordStrength(password));
        }, [password, mode]);

        const switchMode = (newMode) => {
            setMode(newMode);
            setError('');
            setPassword('');
            setConfirmPassword('');
            setResetError('');
            setForgotStep(1);
        };

        // ── LOGIN ──
        const handleLogin = (e) => {
            e.preventDefault();
            setError('');
            if (!email || !password) { setError('Please fill in all fields'); return; }
            setLoading(true);
            setTimeout(() => {
                const users = Storage.get('users') || [];
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
                if (!user) { setError('Invalid email or password'); setLoading(false); return; }

                // Attach branch info
                const branches = Storage.get('branches') || [];
                let userData = { ...user };
                for (const branch of branches) {
                    const member = branch.members?.find(m => m.userId === user.id);
                    if (member) {
                        userData.branchId = branch.id;
                        userData.chainId  = branch.chainId;
                        userData.role     = member.role;
                        userData.isAdmin  = branch.admins?.includes(user.id) || false;
                        break;
                    }
                }
                if (rememberMe) Storage.set('rememberedUser', userData);
                setLoading(false);
                onLogin(userData);
            }, 400);
        };

        // ── SIGNUP ──
        const handleSignup = (e) => {
            e.preventDefault();
            setError('');
            if (!name.trim()) { setError('Please enter your name'); return; }
            if (!email)       { setError('Please enter your email'); return; }
            if (!email.includes('@')) { setError('Please enter a valid email address'); return; }
            if (!password)    { setError('Please enter a password'); return; }
            if (!checkPasswordStrength(password).isValid) { setError(`Password too weak. ${checkPasswordStrength(password).message}`); return; }
            if (password !== confirmPassword) { setError('Passwords do not match'); return; }

            const users = Storage.get('users') || [];
            if (users.find(u => u.email.toLowerCase() === email.toLowerCase())) {
                setError('An account with this email already exists');
                return;
            }

            const privacyAccepted = localStorage.getItem('privacy_accepted');
            if (!privacyAccepted) {
                setPendingSignup({ name: name.trim(), email: email.toLowerCase(), password });
                setShowPrivacy(true);
                return;
            }

            createAccount({ name: name.trim(), email: email.toLowerCase(), password });
        };

        const createAccount = ({ name, email, password }) => {
            const users = Storage.get('users') || [];
            const newUser = {
                id: 'user_' + Date.now(),
                name,
                email,
                password,
                createdAt: new Date().toISOString(),
                privacyAcceptedAt: new Date().toISOString()
            };
            users.push(newUser);
            Storage.set('users', users);
            if (rememberMe) Storage.set('rememberedUser', newUser);
            onLogin(newUser);
        };

        const handlePrivacyAccept = () => {
            localStorage.setItem('privacy_accepted', 'true');
            localStorage.setItem('privacy_accepted_date', new Date().toISOString());
            setShowPrivacy(false);
            if (pendingSignup) { createAccount(pendingSignup); setPendingSignup(null); }
        };

        const handlePrivacyDecline = () => {
            setShowPrivacy(false);
            setPendingSignup(null);
        };

        // ── FORGOT PASSWORD ──
        const handleForgotStep1 = (e) => {
            e.preventDefault();
            setResetError('');
            const users = Storage.get('users') || [];
            const user = users.find(u => u.email.toLowerCase() === resetEmail.toLowerCase());
            if (!user) { setResetError('No account found with this email address'); return; }
            const branches = Storage.get('branches') || [];
            const userBranch = branches.find(b => b.members?.some(m => m.userId === user.id));
            if (!userBranch || userBranch.id !== resetBranchId.trim()) {
                setResetError('Branch ID does not match. Please check and try again');
                return;
            }
            setForgotStep(2);
        };

        const handleForgotStep2 = (e) => {
            e.preventDefault();
            setResetError('');
            if (!resetPassword) { setResetError('Please enter a new password'); return; }
            if (resetPassword.length < 8) { setResetError('Password must be at least 8 characters'); return; }
            if (resetPassword !== resetConfirm) { setResetError('Passwords do not match'); return; }
            const users = Storage.get('users') || [];
            const idx = users.findIndex(u => u.email.toLowerCase() === resetEmail.toLowerCase());
            if (idx === -1) { setResetError('User not found'); return; }
            users[idx].password = resetPassword;
            Storage.set('users', users);
            setForgotStep(3);
            setTimeout(() => {
                setMode('login');
                setEmail(resetEmail);
                setResetEmail('');
                setResetBranchId('');
                setResetPassword('');
                setResetConfirm('');
                setForgotStep(1);
            }, 3000);
        };

        const bg = darkMode
            ? { background: '#001E50' }
            : { background: 'linear-gradient(135deg, #F0F4F8 0%, #E8EEF5 50%, #F0F4F8 100%)' };

        return (
            <div>
                {showPrivacy && (
                    <PrivacyPolicyModal onAccept={handlePrivacyAccept} onDecline={handlePrivacyDecline} />
                )}

                <div className="min-h-screen flex items-center justify-center p-4" style={bg}>
                    {/* Dark mode toggle */}
                    <button
                        onClick={() => setDarkMode(!darkMode)}
                        className="fixed top-4 right-4 p-2.5 rounded-full bg-white dark:bg-gray-800 shadow-lg text-gray-600 dark:text-gray-300 hover:scale-110 transition-transform z-10"
                    >
                        {darkMode ? <Icon.Sun /> : <Icon.Moon />}
                    </button>

                    <div className="w-full max-w-md animate-slideUp">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl mb-4 shadow-lg" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Pharmacy Manager</h1>
                            <p className="text-gray-500 dark:text-gray-400 mt-1 text-sm">
                                {mode === 'login'  && 'Welcome back'}
                                {mode === 'signup' && 'Create your account'}
                                {mode === 'forgot' && 'Reset your password'}
                            </p>
                        </div>

                        <div className="card dark:bg-gray-800 p-8 animate-fadeIn">

                            {/* ── LOGIN FORM ── */}
                            {mode === 'login' && (
                                <>
                                    {error && (
                                        <div className="mb-5 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    <form onSubmit={handleLogin} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email</label>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={e => setEmail(e.target.value)}
                                                className="input-field"
                                                placeholder="your.email@pharmacy.com"
                                                autoComplete="email"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Password</label>
                                            <div className="relative">
                                                <input
                                                    type={showPassword ? 'text' : 'password'}
                                                    value={password}
                                                    onChange={e => setPassword(e.target.value)}
                                                    className="input-field pr-11"
                                                    placeholder="••••••••"
                                                    autoComplete="current-password"
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowPassword(!showPassword)}
                                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                                                >
                                                    {showPassword ? <Icon.EyeOff /> : <Icon.Eye />}
                                                </button>
                                            </div>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={rememberMe}
                                                    onChange={e => setRememberMe(e.target.checked)}
                                                    className="w-4 h-4 rounded border-gray-300 text-blue-600"
                                                />
                                                <span className="text-sm text-gray-600 dark:text-gray-400">Remember me</span>
                                            </label>
                                            <button
                                                type="button"
                                                onClick={() => switchMode('forgot')}
                                                className="text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline"
                                            >
                                                Forgot password?
                                            </button>
                                        </div>
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="w-full btn-primary py-3 rounded-xl font-semibold text-base disabled:opacity-60"
                                        >
                                            {loading ? 'Signing in...' : 'Login'}
                                        </button>
                                    </form>
                                    <p className="text-center text-sm text-gray-600 dark:text-gray-400 mt-6">
                                        Don't have an account?{' '}
                                        <button onClick={() => switchMode('signup')} className="font-semibold text-blue-600 dark:text-blue-400 hover:underline">
                                            Sign up
                                        </button>
                                    </p>
                                </>
                            )}

                            {/* ── SIGNUP FORM ── */}
                            {mode === 'signup' && (
                                <>
                                    {error && (
                                        <div className="mb-5 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    <form onSubmit={handleSignup} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Full Name</label>
                                            <input
                                                type="text"
                                                value={name}
                                                onChange={e => setName(e.target.value)}
                                                className="input-field"
                                                placeholder="John Smith"
                                                autoComplete="name"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email</label>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={e => setEmail(e.target.value)}
                                                className="input-field"
                                                placeholder="your.email@pharmacy.com"
                                                autoComplete="email"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Password</label>
                                            <div className="relative">
                                                <input
                                                    type={showPassword ? 'text' : 'password'}
                                                    value={password}
                                                    onChange={e => setPassword(e.target.value)}
                                                    className="input-field pr-11"
                                                    placeholder="••••••••"
                                                    autoComplete="new-password"
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowPassword(!showPassword)}
                                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                                                >
                                                    {showPassword ? <Icon.EyeOff /> : <Icon.Eye />}
                                                </button>
                                            </div>
                                            {password && (
                                                <div className="mt-2">
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="text-gray-500 dark:text-gray-400">Strength:</span>
                                                        <span className="font-semibold capitalize" style={{ color: pwStrength.color }}>{pwStrength.strength}</span>
                                                    </div>
                                                    <div className="w-full h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                                        <div
                                                            className="h-full rounded-full transition-all duration-300"
                                                            style={{ width: `${pwStrength.score}%`, backgroundColor: pwStrength.color }}
                                                        />
                                                    </div>
                                                    {pwStrength.strength !== 'strong' && (
                                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{pwStrength.message}</p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Confirm Password</label>
                                            <div className="relative">
                                                <input
                                                    type={showConfirm ? 'text' : 'password'}
                                                    value={confirmPassword}
                                                    onChange={e => setConfirmPassword(e.target.value)}
                                                    className="input-field pr-11"
                                                    placeholder="••••••••"
                                                    autoComplete="new-password"
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setShowConfirm(!showConfirm)}
                                                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                                                >
                                                    {showConfirm ? <Icon.EyeOff /> : <Icon.Eye />}
                                                </button>
                                            </div>
                                            {confirmPassword && password !== confirmPassword && (
                                                <p className="text-xs text-red-500 mt-1">Passwords do not match</p>
                                            )}
                                            {confirmPassword && password === confirmPassword && (
                                                <p className="text-xs text-green-600 mt-1">✓ Passwords match</p>
                                            )}
                                        </div>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={rememberMe}
                                                onChange={e => setRememberMe(e.target.checked)}
                                                className="w-4 h-4 rounded border-gray-300 text-blue-600"
                                            />
                                            <span className="text-sm text-gray-600 dark:text-gray-400">Remember me</span>
                                        </label>
                                        <button
                                            type="submit"
                                            className="w-full btn-primary py-3 rounded-xl font-semibold text-base"
                                        >
                                            Create Account
                                        </button>
                                    </form>
                                    <p className="text-center text-sm text-gray-600 dark:text-gray-400 mt-6">
                                        Already have an account?{' '}
                                        <button onClick={() => switchMode('login')} className="font-semibold text-blue-600 dark:text-blue-400 hover:underline">
                                            Login
                                        </button>
                                    </p>
                                </>
                            )}

                            {/* ── FORGOT PASSWORD ── */}
                            {mode === 'forgot' && (
                                <>
                                    {forgotStep === 1 && (
                                        <>
                                            <button
                                                onClick={() => switchMode('login')}
                                                className="flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline mb-5"
                                            >
                                                <Icon.Back /> Back to login
                                            </button>
                                            <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-1">Forgot Password?</h2>
                                            <p className="text-sm text-gray-500 dark:text-gray-400 mb-5">Enter your email and Branch ID to verify your identity</p>
                                            {resetError && (
                                                <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                                    {resetError}
                                                </div>
                                            )}
                                            <form onSubmit={handleForgotStep1} className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email Address</label>
                                                    <input
                                                        type="email"
                                                        value={resetEmail}
                                                        onChange={e => setResetEmail(e.target.value)}
                                                        className="input-field"
                                                        placeholder="your.email@pharmacy.com"
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Branch ID</label>
                                                    <input
                                                        type="text"
                                                        value={resetBranchId}
                                                        onChange={e => setResetBranchId(e.target.value)}
                                                        className="input-field"
                                                        placeholder="e.g. BOOTS-001"
                                                        required
                                                    />
                                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Your Branch ID is used to verify your identity</p>
                                                </div>
                                                <button type="submit" className="w-full btn-primary py-3 rounded-xl font-semibold">
                                                    Continue
                                                </button>
                                            </form>
                                        </>
                                    )}

                                    {forgotStep === 2 && (
                                        <>
                                            <button
                                                onClick={() => setForgotStep(1)}
                                                className="flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline mb-5"
                                            >
                                                <Icon.Back /> Back
                                            </button>
                                            <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-1">Set New Password</h2>
                                            <p className="text-sm text-gray-500 dark:text-gray-400 mb-5">Create a strong new password for your account</p>
                                            {resetError && (
                                                <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                                    {resetError}
                                                </div>
                                            )}
                                            <form onSubmit={handleForgotStep2} className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">New Password</label>
                                                    <div className="relative">
                                                        <input
                                                            type={showResetPw ? 'text' : 'password'}
                                                            value={resetPassword}
                                                            onChange={e => setResetPassword(e.target.value)}
                                                            className="input-field pr-11"
                                                            placeholder="••••••••"
                                                            required
                                                        />
                                                        <button type="button" onClick={() => setShowResetPw(!showResetPw)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                                            {showResetPw ? <Icon.EyeOff /> : <Icon.Eye />}
                                                        </button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Confirm New Password</label>
                                                    <div className="relative">
                                                        <input
                                                            type={showResetPw ? 'text' : 'password'}
                                                            value={resetConfirm}
                                                            onChange={e => setResetConfirm(e.target.value)}
                                                            className="input-field pr-11"
                                                            placeholder="••••••••"
                                                            required
                                                        />
                                                    </div>
                                                    {resetConfirm && resetPassword !== resetConfirm && (
                                                        <p className="text-xs text-red-500 mt-1">Passwords do not match</p>
                                                    )}
                                                </div>
                                                <button type="submit" className="w-full btn-primary py-3 rounded-xl font-semibold">
                                                    Reset Password
                                                </button>
                                            </form>
                                        </>
                                    )}

                                    {forgotStep === 3 && (
                                        <div className="text-center py-6 animate-scaleIn">
                                            <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 dark:text-green-400">
                                                <Icon.Check />
                                            </div>
                                            <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-2">Password Reset!</h2>
                                            <p className="text-gray-500 dark:text-gray-400 text-sm mb-1">Your password has been updated successfully.</p>
                                            <p className="text-gray-400 dark:text-gray-500 text-xs">Redirecting to login...</p>
                                        </div>
                                    )}
                                </>
                            )}

                        </div>
                    </div>
                </div>
        </div>
        );
    }

    // ─── BRANCH SCREEN ─────────────────────────────────────────────────────────
    function BranchScreen({ user, onComplete, darkMode, onBack }) {
        const [mode, setMode] = useState(null); // null | 'create' | 'join'
        const [error, setError] = useState('');

        // Create branch states
        const [branchId, setBranchId]     = useState('');
        const [branchName, setBranchName] = useState('');
        const [chainId, setChainId]       = useState('');
        const [chainName, setChainName]   = useState('');
        const [creatingChain, setCreatingChain] = useState(false);

        // Join branch states
        const [joinId, setJoinId]   = useState('');
        const [joinRole, setJoinRole] = useState('staff');

        const chains   = Storage.get('chains')   || [];
        const branches = Storage.get('branches') || [];

        const handleCreateChain = () => {
            if (!chainId.trim() || !chainName.trim()) { setError('Please enter both Chain ID and Chain Name'); return; }
            if (chains.find(c => c.id === chainId.trim())) { setError('Chain ID already exists'); return; }
            chains.push({ id: chainId.trim(), name: chainName.trim(), createdBy: user.id, createdAt: new Date().toISOString() });
            Storage.set('chains', chains);
            setCreatingChain(false);
            setChainName('');
            setError('');
        };

        const handleCreateBranch = (e) => {
            e.preventDefault();
            setError('');
            if (!branchId.trim())   { setError('Please enter a Branch ID'); return; }
            if (!branchName.trim()) { setError('Please enter a Branch Name'); return; }
            if (!chainId)           { setError('Please select or create a Chain first'); return; }
            if (branches.find(b => b.id === branchId.trim())) { setError('Branch ID already exists. Please choose a different one'); return; }

            const newBranch = {
                id: branchId.trim(),
                name: branchName.trim(),
                chainId,
                admins:   [user.id],
                members:  [{ userId: user.id, role: 'branch-admin', joinedAt: new Date().toISOString() }],
                pendingRequests: [],
                createdAt: new Date().toISOString()
            };
            branches.push(newBranch);
            Storage.set('branches', branches);

            const updatedUser = { ...user, branchId: branchId.trim(), chainId, isAdmin: true, role: 'branch-admin' };
            Storage.set('rememberedUser', updatedUser);
            onComplete(updatedUser);
        };

        const handleJoinBranch = (e) => {
            e.preventDefault();
            setError('');
            if (!joinId.trim()) { setError('Please enter a Branch ID'); return; }
            const branch = branches.find(b => b.id === joinId.trim());
            if (!branch) { setError('Branch not found. Please check the ID and try again'); return; }
            if (branch.members?.find(m => m.userId === user.id)) { setError('You are already a member of this branch'); return; }
            if (branch.pendingRequests?.find(r => r.userId === user.id)) { setError('You already have a pending request for this branch'); return; }

            if (!branch.pendingRequests) branch.pendingRequests = [];
            branch.pendingRequests.push({
                userId: user.id,
                userName: user.name,
                userEmail: user.email,
                requestedRole: joinRole,
                requestedAt: new Date().toISOString()
            });
            Storage.set('branches', branches);
            alert('✓ Join request sent!\n\nYour request has been sent to the branch admin. You can log in again once they approve you.');
        };

        const bg = darkMode
            ? { background: '#001E50' }
            : { background: 'linear-gradient(135deg, #F0F4F8 0%, #E8EEF5 50%, #F0F4F8 100%)' };

        return (
            <div>
                <div className="min-h-screen flex items-center justify-center p-4" style={bg}>
                    <div className="w-full max-w-md animate-slideUp">

                        {/* Back button */}
                        <button
                            onClick={onBack}
                            className="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 mb-6 transition-colors group"
                        >
                            <svg className="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            Back to login
                        </button>

                        {/* Header */}
                        <div className="text-center mb-8">
                            <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl mb-4 shadow-lg" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                                <Icon.Building />
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Branch Setup</h1>
                            <p className="text-gray-500 dark:text-gray-400 mt-1 text-sm">Welcome, {user.name}!</p>
                        </div>

                        <div className="card dark:bg-gray-800 p-8 animate-fadeIn">

                            {/* Choice screen */}
                            {!mode && (
                                <div className="space-y-4">
                                    <p className="text-center text-gray-600 dark:text-gray-400 mb-6">
                                        Are you setting up a new branch or joining an existing one?
                                    </p>
                                    <button
                                        onClick={() => setMode('create')}
                                        className="w-full btn-primary py-4 rounded-xl font-semibold text-lg"
                                    >
                                        Create New Branch
                                    </button>
                                    <button
                                        onClick={() => setMode('join')}
                                        className="w-full btn-success py-4 rounded-xl font-semibold text-lg"
                                    >
                                        Join Existing Branch
                                    </button>
                                </div>
                            )}

                            {/* Create branch */}
                            {mode === 'create' && (
                                <>
                                    <button
                                        onClick={() => { setMode(null); setError(''); }}
                                        className="flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline mb-5"
                                    >
                                        <Icon.Back /> Back
                                    </button>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-5">Create New Branch</h2>
                                    {error && (
                                        <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}

                                    {/* Chain selection */}
                                    <div className="mb-5">
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Chain</label>
                                        {chains.length > 0 && !creatingChain && (
                                            <select
                                                value={chainId}
                                                onChange={e => setChainId(e.target.value)}
                                                className="input-field mb-2"
                                            >
                                                <option value="">Select a chain...</option>
                                                {chains.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                            </select>
                                        )}
                                        {!creatingChain && (
                                            <button
                                                type="button"
                                                onClick={() => setCreatingChain(true)}
                                                className="text-sm text-blue-600 dark:text-blue-400 hover:underline"
                                            >
                                                + Create new chain
                                            </button>
                                        )}
                                        {creatingChain && (
                                            <div className="p-4 border-2 border-blue-300 dark:border-blue-700 rounded-xl space-y-3">
                                                <p className="text-sm font-semibold text-gray-700 dark:text-gray-300">New Chain</p>
                                                <input
                                                    type="text"
                                                    value={chainId}
                                                    onChange={e => setChainId(e.target.value)}
                                                    className="input-field"
                                                    placeholder="Chain ID (e.g. BOOTS-UK)"
                                                />
                                                <input
                                                    type="text"
                                                    value={chainName}
                                                    onChange={e => setChainName(e.target.value)}
                                                    className="input-field"
                                                    placeholder="Chain Name (e.g. Boots UK)"
                                                />
                                                <div className="flex gap-2">
                                                    <button onClick={handleCreateChain} className="flex-1 btn-primary py-2 rounded-lg text-sm font-semibold">Create Chain</button>
                                                    <button onClick={() => { setCreatingChain(false); setChainId(''); setChainName(''); setError(''); }} className="flex-1 py-2 rounded-lg text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <form onSubmit={handleCreateBranch} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Branch ID *</label>
                                            <input
                                                type="text"
                                                value={branchId}
                                                onChange={e => setBranchId(e.target.value)}
                                                className="input-field"
                                                placeholder="e.g. BOOTS-001"
                                            />
                                            <p className="text-xs text-gray-400 mt-1">This is the ID staff will use to join your branch</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Branch Name *</label>
                                            <input
                                                type="text"
                                                value={branchName}
                                                onChange={e => setBranchName(e.target.value)}
                                                className="input-field"
                                                placeholder="e.g. Boots High Street"
                                            />
                                        </div>
                                        <button type="submit" className="w-full btn-primary py-3 rounded-xl font-semibold">
                                            Create Branch
                                        </button>
                                    </form>
                                </>
                            )}

                            {/* Join branch */}
                            {mode === 'join' && (
                                <>
                                    <button
                                        onClick={() => { setMode(null); setError(''); }}
                                        className="flex items-center gap-2 text-sm text-blue-600 dark:text-blue-400 hover:underline mb-5"
                                    >
                                        <Icon.Back /> Back
                                    </button>
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-1">Join Branch</h2>
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-5">Ask your branch admin for the Branch ID</p>
                                    {error && (
                                        <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                            {error}
                                        </div>
                                    )}
                                    <form onSubmit={handleJoinBranch} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Branch ID *</label>
                                            <input
                                                type="text"
                                                value={joinId}
                                                onChange={e => setJoinId(e.target.value)}
                                                className="input-field"
                                                placeholder="Enter the Branch ID"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Your Job Role</label>
                                            <select
                                                value={joinRole}
                                                onChange={e => setJoinRole(e.target.value)}
                                                className="input-field"
                                            >
                                                <option value="pharmacist">Pharmacist</option>
                                                <option value="act_pharmacist">ACT Pharmacist</option>
                                                <option value="pharmacy_technician">Pharmacy Technician</option>
                                                <option value="dispenser">Dispenser</option>
                                                <option value="counter_assistant">Counter Assistant</option>
                                                <option value="manager">Manager</option>
                                                <option value="trainee_technician">Trainee Technician</option>
                                                <option value="medicines_counter">Medicines Counter</option>
                                                <option value="admin_staff">Admin Staff</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <button type="submit" className="w-full btn-success py-3 rounded-xl font-semibold">
                                            Send Join Request
                                        </button>
                                    </form>
                                </>
                            )}

                        </div>
                    </div>
                </div>
            </div>
        );
    }
    // ─── PLACEHOLDER TAB CONTENT ───────────────────────────────────────────────
    function PlaceholderTab({ icon, title, description }) {
        return (
            <div className="flex flex-col items-center justify-center h-64 animate-fadeIn">
                <div className="w-16 h-16 rounded-2xl flex items-center justify-center mb-4 text-white" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                    {icon}
                </div>
                <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">{title}</h3>
                <p className="text-gray-500 dark:text-gray-400 text-sm text-center max-w-xs">{description}</p>
            </div>
        );
    }

    // ─── DASHBOARD TAB ─────────────────────────────────────────────────────────
    function DashboardTab({ user, branch, isAdmin, setCurrentTab }) {
        const branchId  = branch?.id;
        const tasks     = Storage.get(`tasks_${branchId}`)    || [];
        const reminders = Storage.get(`reminders_${branchId}`) || [];

        // Count messages across all channels
        const channels   = Storage.get(`channels_${branchId}`) || [];
        const msgCount   = channels.reduce((sum, ch) => {
            const msgs = Storage.get(`msgs_${branchId}_${ch.id}`) || [];
            return sum + msgs.length;
        }, 0);
        // Gather all messages for recent activity
        const allMessages = channels.flatMap(ch => Storage.get(`msgs_${branchId}_${ch.id}`) || []);

        // Cleared timestamp — hides activity older than this point
        const [clearedAt, setClearedAt] = useState(() => Storage.get(`activity_cleared_${branchId}`) || null);

        const clearActivity = () => {
            const ts = new Date().toISOString();
            setClearedAt(ts);
            Storage.set(`activity_cleared_${branchId}`, ts);
        };

        const activeTasks      = tasks.filter(t => !t.completed).length;
        const pendingReminders = reminders.filter(r => !r.completed).length;
        const totalMessages    = msgCount;
        const teamMembers      = branch?.members?.length || 0;

        // Recent activity: last 5 items across tasks and messages, sorted by date
        const recentActivity = [
            ...tasks.map(t => ({
                id:   `task-${t.id}`,
                type: 'task',
                text: t.title,
                sub:  t.completed ? 'Task completed' : `Priority: ${t.priority}`,
                time: t.completedAt || t.createdAt,
                done: t.completed
            })),
            ...allMessages.map(m => ({
                id:   `msg-${m.id}`,
                type: 'message',
                text: m.userName,
                sub:  m.text.length > 50 ? m.text.slice(0, 50) + '…' : m.text,
                time: m.timestamp,
                done: false
            }))
        ]
        .filter(item => !clearedAt || new Date(item.time) > new Date(clearedAt))
        .sort((a, b) => new Date(b.time) - new Date(a.time))
        .slice(0, 5);

        const formatTime = (iso) => {
            const d    = new Date(iso);
            const now  = new Date();
            const diff = now - d;
            const mins = Math.floor(diff / 60000);
            const hrs  = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (mins < 1)  return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            if (hrs  < 24) return `${hrs}h ago`;
            if (days < 7)  return `${days}d ago`;
            return d.toLocaleDateString();
        };

        const statCards = [
            {
                label:  'Active Tasks',
                value:  activeTasks,
                icon:   <Icon.Tasks />,
                color:  '#005EB8',
                bg:     'bg-blue-50 dark:bg-blue-900/20',
                tab:    'tasks'
            },
            {
                label:  'Pending Reminders',
                value:  pendingReminders,
                icon:   <Icon.Reminders />,
                color:  '#F59E0B',
                bg:     'bg-amber-50 dark:bg-amber-900/20',
                tab:    'reminders'
            },
            {
                label:  'Messages',
                value:  totalMessages,
                icon:   <Icon.Messages />,
                color:  '#009639',
                bg:     'bg-green-50 dark:bg-green-900/20',
                tab:    'messages'
            },
            {
                label:  'Team Members',
                value:  teamMembers,
                icon:   <Icon.Staff />,
                color:  '#7C3AED',
                bg:     'bg-purple-50 dark:bg-purple-900/20',
                tab:    'staff'
            },
        ];

        const quickActions = [
            { label: 'New Task',    icon: <Icon.Tasks />,    tab: 'tasks',    color: '#005EB8' },
            { label: 'Messages',    icon: <Icon.Messages />, tab: 'messages', color: '#009639' },
            { label: 'Handover',    icon: <Icon.Handover />, tab: 'handover', color: '#7C3AED' },
            { label: 'Notices',     icon: <Icon.Notices />,  tab: 'notices',  color: '#DA291C' },
        ];

        return (
            <div className="space-y-6 animate-fadeIn">

                {/* Welcome banner */}
                <div className="rounded-2xl p-5 text-white shadow-lg" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                    <p className="text-blue-200 text-sm mb-1">
                        {new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </p>
                    <h2 className="text-2xl font-bold mb-1">Hello, {user.name.split(' ')[0]}!</h2>
                    <p className="text-blue-200 text-sm">
                        {branch?.name} &bull; {isAdmin ? 'Administrator' : 'Staff Member'}
                    </p>
                    {activeTasks > 0 && (
                        <div className="mt-3 inline-flex items-center gap-2 bg-white/20 rounded-lg px-3 py-1.5">
                            <span className="w-2 h-2 rounded-full bg-amber-400 animate-pulse" />
                            <span className="text-sm font-medium">{activeTasks} task{activeTasks !== 1 ? 's' : ''} need attention</span>
                        </div>
                    )}
                </div>

                {/* Stats grid */}
                <div>
                    <h3 className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Overview</h3>
                    <div className="grid grid-cols-2 gap-3">
                        {statCards.map(card => (
                            <button
                                key={card.label}
                                onClick={() => setCurrentTab(card.tab)}
                                className={`${card.bg} rounded-2xl p-4 text-left transition-all hover:scale-105 active:scale-95 border border-transparent hover:border-gray-200 dark:hover:border-gray-600`}
                            >
                                <div className="flex items-center justify-between mb-2">
                                    <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white" style={{background: card.color}}>
                                        {card.icon}
                                    </div>
                                    <span className="text-2xl font-bold text-gray-800 dark:text-white">{card.value}</span>
                                </div>
                                <p className="text-xs font-medium text-gray-600 dark:text-gray-400">{card.label}</p>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Quick actions */}
                <div>
                    <h3 className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Quick Actions</h3>
                    <div className="grid grid-cols-4 gap-2">
                        {quickActions.map(action => (
                            <button
                                key={action.label}
                                onClick={() => setCurrentTab(action.tab)}
                                className="flex flex-col items-center gap-2 p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 hover:scale-105 active:scale-95 transition-all"
                            >
                                <div className="w-10 h-10 rounded-xl flex items-center justify-center text-white" style={{background: action.color}}>
                                    {action.icon}
                                </div>
                                <span className="text-xs font-medium text-gray-600 dark:text-gray-400 text-center leading-tight">{action.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Recent activity */}
                <div>
                    <div className="flex items-center justify-between mb-3">
                        <h3 className="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Recent Activity</h3>
                        {recentActivity.length > 0 && (
                            <button
                                onClick={clearActivity}
                                title="Clear recent activity"
                                className="p-1.5 rounded-lg text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        )}
                    </div>
                    {recentActivity.length === 0 ? (
                        <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 text-center border border-gray-100 dark:border-gray-700">
                            <div className="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                                <Icon.Home />
                            </div>
                            <p className="text-gray-500 dark:text-gray-400 text-sm">No activity yet.</p>
                            <p className="text-gray-400 dark:text-gray-500 text-xs mt-1">Create a task or send a message to get started.</p>
                        </div>
                    ) : (
                        <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 overflow-hidden">
                            {recentActivity.map((item, idx) => (
                                <div
                                    key={item.id}
                                    className={`flex items-center gap-3 px-4 py-3 ${idx < recentActivity.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : ''}`}
                                >
                                    <div
                                        className="w-8 h-8 rounded-lg flex items-center justify-center text-white flex-shrink-0"
                                        style={{background: item.type === 'task' ? '#005EB8' : '#009639'}}
                                    >
                                        {item.type === 'task' ? <Icon.Tasks /> : <Icon.Messages />}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className={`text-sm font-medium text-gray-800 dark:text-white truncate ${item.done ? 'line-through opacity-50' : ''}`}>
                                            {item.text}
                                        </p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{item.sub}</p>
                                    </div>
                                    <span className="text-xs text-gray-400 dark:text-gray-500 flex-shrink-0">{formatTime(item.time)}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

            </div>
        );
    }

    // ─── TASKS TAB ─────────────────────────────────────────────────────────────
    function TasksTab({ user, branch, isAdmin, unseenReports = 0 }) {
        const branchId = branch?.id;
        const members  = branch?.members || [];

        const [tasks,      setTasks]      = useState(Storage.get(`tasks_${branchId}`) || []);
        const [filter,     setFilter]     = useState('active');
        const [showCreate, setShowCreate] = useState(false);
        const [newTask,    setNewTask]    = useState({
            title: '', description: '', priority: 'medium', dueDate: '', assignedTo: ''
        });
        const [error, setError] = useState('');

        const saveTasks = (updated) => {
            setTasks(updated);
            Storage.set(`tasks_${branchId}`, updated);
        };

        const [showReports,  setShowReports]  = useState(false);
        const [reportsList,  setReportsList]  = useState(() => Storage.get(`reports_${branchId}`) || []);

        const getReports    = () => reportsList;
        const markReportsSeen = () => {
            const updated = reportsList.map(r => ({ ...r, seen: true }));
            Storage.set(`reports_${branchId}`, updated);
            setReportsList(updated);
        };
        const deleteReport = (repId) => {
            const updated = reportsList.filter(r => r.id !== repId);
            Storage.set(`reports_${branchId}`, updated);
            setReportsList(updated);
        };

        const handleCreate = (e) => {
            e.preventDefault();
            setError('');
            if (!newTask.title.trim()) { setError('Please enter a task title'); return; }
            const task = {
                id:          'task_' + Date.now(),
                title:       newTask.title.trim(),
                description: newTask.description.trim(),
                priority:    newTask.priority,
                dueDate:     newTask.dueDate,
                assignedTo:  newTask.assignedTo,
                createdBy:   user.id,
                createdByName: user.name,
                createdAt:   new Date().toISOString(),
                completed:   false,
                completedAt: null
            };
            saveTasks([...tasks, task]);
            setNewTask({ title: '', description: '', priority: 'medium', dueDate: '', assignedTo: '' });
            setShowCreate(false);
        };

        const toggleComplete = (task) => {
            // If already completed, only the person who completed it can uncheck
            if (task.completed && task.completedBy !== user.id) return;
            saveTasks(tasks.map(t =>
                t.id === task.id
                    ? { ...t,
                        completed:   !t.completed,
                        completedAt: !t.completed ? new Date().toISOString() : null,
                        completedBy: !t.completed ? user.id : null,
                        completedByName: !t.completed ? user.name : null
                      }
                    : t
            ));
        };

        const [reportTaskId, setReportTaskId] = useState(null);
        const [reportText,   setReportText]   = useState('');
        const [reportError,  setReportError]  = useState('');
        const [reportToast,  setReportToast]  = useState(false);

        const submitReport = (e) => {
            e.preventDefault();
            setReportError('');
            if (!reportText.trim()) { setReportError('Please describe the issue'); return; }
            const task = tasks.find(t => t.id === reportTaskId);
            if (!task) return;
            const reports = Storage.get(`reports_${branchId}`) || [];
            reports.push({
                id:           'rep_' + Date.now(),
                taskId:       task.id,
                taskTitle:    task.title,
                reportedBy:   user.id,
                reportedByName: user.name,
                reportText:   reportText.trim(),
                reportedAt:   new Date().toISOString(),
                seen:         false
            });
            Storage.set(`reports_${branchId}`, reports);
            setReportsList(reports);
            setReportTaskId(null);
            setReportText('');
            setReportToast(true);
            setTimeout(() => setReportToast(false), 2500);
        };

        const formatDuration = (start, end) => {
            const ms   = new Date(end) - new Date(start);
            const mins = Math.floor(ms / 60000);
            const hrs  = Math.floor(mins / 60);
            const days = Math.floor(hrs / 24);
            if (days > 0)  return `${days}d ${hrs % 24}h`;
            if (hrs > 0)   return `${hrs}h ${mins % 60}m`;
            if (mins > 0)  return `${mins}m`;
            return 'Under 1m';
        };

        const deleteTask = (taskId) => {
            if (!window.confirm('Delete this task? This cannot be undone.')) return;
            saveTasks(tasks.filter(t => t.id !== taskId));
        };

        const filtered = filter === 'all'       ? tasks
                       : filter === 'active'    ? tasks.filter(t => !t.completed)
                       : tasks.filter(t => t.completed);

        const priorityStyle = {
            high:   { bg: 'bg-red-100 dark:bg-red-900/30',    text: 'text-red-700 dark:text-red-400',    dot: 'bg-red-500'    },
            medium: { bg: 'bg-amber-100 dark:bg-amber-900/30', text: 'text-amber-700 dark:text-amber-400', dot: 'bg-amber-500' },
            low:    { bg: 'bg-gray-100 dark:bg-gray-700',      text: 'text-gray-600 dark:text-gray-400',   dot: 'bg-gray-400'  },
        };

        const formatDue = (dateStr) => {
            if (!dateStr) return null;
            const due  = new Date(dateStr);
            const now  = new Date();
            const diff = due - now;
            const days = Math.ceil(diff / 86400000);
            if (days < 0)  return { label: `${Math.abs(days)}d overdue`, color: 'text-red-500 dark:text-red-400' };
            if (days === 0) return { label: 'Due today',                  color: 'text-amber-500 dark:text-amber-400' };
            if (days === 1) return { label: 'Due tomorrow',               color: 'text-amber-500 dark:text-amber-400' };
            return { label: `Due in ${days}d`, color: 'text-gray-500 dark:text-gray-400' };
        };

        const counts = {
            all:       tasks.length,
            active:    tasks.filter(t => !t.completed).length,
            completed: tasks.filter(t =>  t.completed).length
        };

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Report sent toast */}
                {reportToast && (
                    <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex items-center gap-2 bg-green-500 text-white text-sm font-semibold px-5 py-3 rounded-2xl shadow-xl animate-fadeIn pointer-events-none">
                        <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        Report sent to admin
                    </div>
                )}

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Tasks</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">{counts.active} active · {counts.completed} completed</p>
                    </div>
                    {isAdmin && (
                    <button
                        onClick={() => setShowCreate(true)}
                        className="btn-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                    >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        New Task
                    </button>
                    )}
                </div>

                {/* Admin: unseen reports notification */}
                {isAdmin && unseenReports > 0 && (
                    <button
                        onClick={() => { setShowReports(true); markReportsSeen(); }}
                        className="w-full flex items-center gap-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-2xl px-4 py-3 text-left hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors"
                    >
                        <div className="w-8 h-8 bg-amber-400 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                            </svg>
                        </div>
                        <div className="flex-1">
                            <p className="text-sm font-semibold text-amber-700 dark:text-amber-400">{unseenReports} new task report{unseenReports > 1 ? 's' : ''}</p>
                            <p className="text-xs text-amber-600 dark:text-amber-500">Tap to review</p>
                        </div>
                        <svg className="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                    </button>
                )}
                {isAdmin && unseenReports === 0 && getReports().length > 0 && (
                    <button
                        onClick={() => setShowReports(true)}
                        className="w-full text-xs text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 text-left py-1 transition-colors"
                    >
                        View all task reports ({getReports().length})
                    </button>
                )}

                {/* Filter tabs */}
                <div className="flex gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl">
                    {['all', 'active', 'completed'].map(f => (
                        <button
                            key={f}
                            onClick={() => setFilter(f)}
                            className={`flex-1 py-2 rounded-lg text-sm font-medium capitalize transition-all
                                ${filter === f
                                    ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-sm'
                                    : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                                }`}
                        >
                            {f} {counts[f] > 0 && <span className="ml-1 text-xs opacity-70">({counts[f]})</span>}
                        </button>
                    ))}
                </div>

                {/* Task list */}
                {filtered.length === 0 ? (
                    <div className="bg-white dark:bg-gray-800 rounded-2xl p-10 text-center border border-gray-100 dark:border-gray-700">
                        <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-400">
                            <Icon.Tasks />
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 font-medium">No {filter} tasks</p>
                        <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">
                            {filter === 'active' ? 'All caught up! Tap "+ New Task" to add one.' : 'Nothing here yet.'}
                        </p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {filtered.map(task => {
                            const p   = priorityStyle[task.priority] || priorityStyle.medium;
                            const due = formatDue(task.dueDate);
                            return (
                                <div
                                    key={task.id}
                                    className={`bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-100 dark:border-gray-700 shadow-sm transition-all ${task.completed ? 'opacity-70' : ''}`}
                                >
                                    <div className="flex items-start gap-3">
                                        {/* Checkbox */}
                                        <button
                                            onClick={() => toggleComplete(task)}
                                            title={task.completed && task.completedBy !== user.id ? 'Only ' + task.completedByName + ' can unmark this' : ''}
                                            className={`mt-0.5 w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all
                                                ${task.completed
                                                    ? task.completedBy === user.id
                                                        ? 'bg-green-500 border-green-500 cursor-pointer'
                                                        : 'bg-green-500 border-green-500 cursor-not-allowed opacity-70'
                                                    : 'border-gray-300 dark:border-gray-600 hover:border-blue-400'
                                                }`}
                                        >
                                            {task.completed && (
                                                <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                </svg>
                                            )}
                                        </button>

                                        {/* Content */}
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2 flex-wrap mb-1">
                                                <span className={`font-semibold text-gray-800 dark:text-white text-sm ${task.completed ? 'line-through opacity-50' : ''}`}>
                                                    {task.title}
                                                </span>
                                                <span className={`inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full font-medium ${p.bg} ${p.text}`}>
                                                    <span className={`w-1.5 h-1.5 rounded-full ${p.dot}`} />
                                                    {task.priority}
                                                </span>
                                            </div>
                                            {task.description && (
                                                <p className="text-xs text-gray-500 dark:text-gray-400 mb-1.5 leading-relaxed">{task.description}</p>
                                            )}
                                            <div className="flex items-center gap-3 flex-wrap">
                                                <span className="text-xs text-gray-400 dark:text-gray-500">
                                                    By {task.createdByName}
                                                </span>
                                                {due && (
                                                    <span className={`text-xs font-medium ${due.color}`}>
                                                        {due.label}
                                                    </span>
                                                )}
                                                {task.assignedTo && (
                                                    <span className="text-xs text-blue-600 dark:text-blue-400">
                                                        → {task.assignedTo}
                                                    </span>
                                                )}
                                                {task.completed && task.completedAt && (
                                                    <span className="text-xs text-green-600 dark:text-green-400 font-medium">
                                                        ✓ {task.completedByName || 'Done'} · {formatDuration(task.createdAt, task.completedAt)}
                                                    </span>
                                                )}
                                            </div>
                                        </div>

                                        {/* Actions: report + delete */}
                                        <div className="flex items-center gap-1 flex-shrink-0 ml-1">
                                            {/* Report button — all users */}
                                            <button
                                                onClick={() => { setReportTaskId(task.id); setReportText(''); setReportError(''); }}
                                                title="Report an issue with this task"
                                                className="text-gray-300 dark:text-gray-600 hover:text-amber-500 dark:hover:text-amber-400 transition-colors p-1"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                                                </svg>
                                            </button>
                                            {/* Delete — admin only */}
                                            {isAdmin && (
                                                <button
                                                    onClick={() => deleteTask(task.id)}
                                                    className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}

                {/* Reports panel (admin) */}
                {showReports && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowReports(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Task Reports</h3>
                                <button onClick={() => setShowReports(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <div className="overflow-y-auto flex-1 p-4 space-y-3">
                                {getReports().length === 0 ? (
                                    <p className="text-sm text-gray-400 dark:text-gray-500 text-center py-8">No reports yet</p>
                                ) : (
                                    [...getReports()].reverse().map(rep => (
                                        <div key={rep.id} className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-3 border border-gray-100 dark:border-gray-700">
                                            <div className="flex items-start justify-between mb-1">
                                                <p className="text-xs font-semibold text-amber-600 dark:text-amber-400 truncate flex-1">Task: {rep.taskTitle}</p>
                                                <div className="flex items-center gap-2 ml-2 flex-shrink-0">
                                                    {!rep.seen && <span className="text-xs bg-amber-400 text-white px-1.5 py-0.5 rounded-full">New</span>}
                                                    <button
                                                        onClick={() => deleteReport(rep.id)}
                                                        title="Delete report"
                                                        className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            <p className="text-sm text-gray-700 dark:text-gray-300 mb-2">{rep.reportText}</p>
                                            <p className="text-xs text-gray-400 dark:text-gray-500">
                                                Reported by {rep.reportedByName} · {new Date(rep.reportedAt).toLocaleDateString('en-GB', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' })}
                                            </p>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* Report modal */}
                {reportTaskId && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setReportTaskId(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-amber-100 dark:bg-amber-900/30 rounded-lg flex items-center justify-center">
                                        <svg className="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-800 dark:text-white">Report Task Issue</h3>
                                </div>
                                <button onClick={() => setReportTaskId(null)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={submitReport} className="p-5 space-y-4">
                                <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-3">
                                    <p className="text-xs text-amber-700 dark:text-amber-400 font-medium truncate">
                                        Task: {tasks.find(t => t.id === reportTaskId)?.title}
                                    </p>
                                </div>
                                {reportError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{reportError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Describe the issue *</label>
                                    <textarea
                                        value={reportText}
                                        onChange={e => setReportText(e.target.value)}
                                        className="input-field resize-none"
                                        rows={4}
                                        placeholder="Describe the problem with this task..."
                                        autoFocus
                                    />
                                </div>
                                <p className="text-xs text-gray-400 dark:text-gray-500">Your report will be sent to the branch admin.</p>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setReportTaskId(null)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium">Cancel</button>
                                    <button type="submit" className="flex-1 py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-semibold">Send Report</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* Create task modal */}
                {showCreate && (
                    <div
                        className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4"
                        onClick={() => setShowCreate(false)}
                    >
                        <div
                            className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp"
                            onClick={e => e.stopPropagation()}
                        >
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">New Task</h3>
                                <button
                                    onClick={() => setShowCreate(false)}
                                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <form onSubmit={handleCreate} className="p-5 space-y-4">
                                {error && (
                                    <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Title *</label>
                                    <input
                                        type="text"
                                        value={newTask.title}
                                        onChange={e => setNewTask({...newTask, title: e.target.value})}
                                        className="input-field"
                                        placeholder="What needs to be done?"
                                        autoFocus
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
                                    <textarea
                                        value={newTask.description}
                                        onChange={e => setNewTask({...newTask, description: e.target.value})}
                                        className="input-field resize-none"
                                        rows={3}
                                        placeholder="Optional details..."
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Priority</label>
                                        <select
                                            value={newTask.priority}
                                            onChange={e => setNewTask({...newTask, priority: e.target.value})}
                                            className="input-field"
                                        >
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Due Date</label>
                                        <input
                                            type="date"
                                            value={newTask.dueDate}
                                            onChange={e => setNewTask({...newTask, dueDate: e.target.value})}
                                            className="input-field"
                                            min={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Assign To</label>
                                    <select
                                        value={newTask.assignedTo}
                                        onChange={e => setNewTask({...newTask, assignedTo: e.target.value})}
                                        className="input-field"
                                    >
                                        <option value="">Anyone</option>
                                        {members.map((m, i) => {
                                            const users = Storage.get('users') || [];
                                            const u = users.find(u => u.id === m.userId);
                                            return u ? <option key={i} value={u.name}>{u.name}</option> : null;
                                        })}
                                    </select>
                                </div>

                                <div className="flex gap-3 pt-1">
                                    <button
                                        type="button"
                                        onClick={() => setShowCreate(false)}
                                        className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 btn-primary py-3 rounded-xl font-semibold"
                                    >
                                        Create Task
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── MESSAGES TAB ──────────────────────────────────────────────────────────
    function MessagesTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;

        const defaultChannels = [
            { id: 'ch_general',    name: 'general',    description: 'General team chat' },
            { id: 'ch_dispensary', name: 'dispensary', description: 'Dispensary updates' },
            { id: 'ch_urgent',     name: 'urgent',     description: 'Urgent notices only' },
        ];

        const [channels,       setChannels]       = useState(() => {
            const saved = Storage.get(`channels_${branchId}`);
            if (saved && saved.length > 0) return saved;
            Storage.set(`channels_${branchId}`, defaultChannels);
            return defaultChannels;
        });
        const [activeChannel,  setActiveChannel]  = useState(channels[0]);
        const [showSidebar,    setShowSidebar]     = useState(() => window.innerWidth >= 640);
        const [text,           setText]            = useState('');
        const [messages,       setMessages]        = useState(Storage.get(`msgs_${branchId}_${channels[0]?.id}`) || []);

        // Channel management states
        const [showCreateCh,   setShowCreateCh]   = useState(false);
        const [editingCh,      setEditingCh]       = useState(null);
        const [newChName,      setNewChName]       = useState('');
        const [newChDesc,      setNewChDesc]       = useState('');
        const [chError,        setChError]         = useState('');
        const [chAllowedRoles, setChAllowedRoles]  = useState([]); // [] = everyone

        // Confidentiality acknowledgement — stored per user per branch
        const confKey = `conf_ack_${branchId}_${user.id}`;
        const [confAck, setConfAck] = useState(() => Storage.get(confKey) || false);

        const handleConfAck = () => {
            Storage.set(confKey, true);
            // Save audit log entry for legal purposes
            const log = Storage.get(`conf_log_${branchId}`) || [];
            log.push({ userId: user.id, userName: user.name, acknowledgedAt: new Date().toISOString() });
            Storage.set(`conf_log_${branchId}`, log);
            setConfAck(true);
        };

        const bottomRef = React.useRef(null);

        // Load messages when channel changes
        useEffect(() => {
            if (activeChannel) {
                setMessages(Storage.get(`msgs_${branchId}_${activeChannel.id}`) || []);
            }
        }, [activeChannel]);

        useEffect(() => {
            bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const saveChannels = (updated) => {
            setChannels(updated);
            Storage.set(`channels_${branchId}`, updated);
        };

        const handleCreateChannel = (e) => {
            e.preventDefault();
            setChError('');
            const name = newChName.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (!name) { setChError('Please enter a channel name'); return; }
            if (channels.find(c => c.name === name)) { setChError('A channel with this name already exists'); return; }
            const ch = { id: 'ch_' + Date.now(), name, description: newChDesc.trim() };
            saveChannels([...channels, ch]);
            setNewChName('');
            setNewChDesc('');
            setShowCreateCh(false);
        };

        const handleEditChannel = (e) => {
            e.preventDefault();
            setChError('');
            const name = newChName.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (!name) { setChError('Please enter a channel name'); return; }
            const conflict = channels.find(c => c.name === name && c.id !== editingCh.id);
            if (conflict) { setChError('A channel with this name already exists'); return; }
            const updated = channels.map(c =>
                c.id === editingCh.id ? { ...c, name, description: newChDesc.trim(), allowedRoles: chAllowedRoles } : c
            );
            saveChannels(updated);
            if (activeChannel.id === editingCh.id) setActiveChannel({ ...activeChannel, name, description: newChDesc.trim(), allowedRoles: chAllowedRoles });
            setEditingCh(null);
            setNewChName('');
            setNewChDesc('');
        };

        const handleDeleteChannel = (ch) => {
            if (channels.length <= 1) { alert('You must keep at least one channel.'); return; }
            if (!window.confirm(`Delete #${ch.name}? All messages in this channel will be lost.`)) return;
            const updated = channels.filter(c => c.id !== ch.id);
            saveChannels(updated);
            Storage.remove(`msgs_${branchId}_${ch.id}`);
            if (activeChannel.id === ch.id) {
                setActiveChannel(updated[0]);
            }
            setEditingCh(null);
        };

        const sendMessage = () => {
            const trimmed = text.trim();
            if (!trimmed || !activeChannel) return;
            const msg = {
                id:        'msg_' + Date.now(),
                text:      trimmed,
                userId:    user.id,
                userName:  user.name,
                timestamp: new Date().toISOString()
            };
            const updated = [...messages, msg];
            setMessages(updated);
            Storage.set(`msgs_${branchId}_${activeChannel.id}`, updated);
            setText('');
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        };

        const formatTime = (iso) => {
            const d   = new Date(iso);
            const now = new Date();
            const diff = now - d;
            const mins = Math.floor(diff / 60000);
            const hrs  = Math.floor(diff / 3600000);
            if (mins < 1)  return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            if (hrs  < 24) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return d.toLocaleDateString([], { day: 'numeric', month: 'short' });
        };

        // Group messages with date dividers
        const withDividers = [];
        let lastDate = null;
        messages.forEach(msg => {
            const dateLabel = new Date(msg.timestamp).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
            if (dateLabel !== lastDate) {
                withDividers.push({ type: 'divider', label: dateLabel, id: 'div_' + msg.id });
                lastDate = dateLabel;
            }
            withDividers.push({ type: 'message', ...msg });
        });

        const openEdit = (ch) => {
            setEditingCh(ch);
            setNewChName(ch.name);
            setNewChDesc(ch.description || '');
            setChAllowedRoles(ch.allowedRoles || []);
            setChError('');
        };

        const canAccessChannel = (ch) => {
            if (isAdmin) return true;
            if (!ch.allowedRoles || ch.allowedRoles.length === 0) return true;
            const allBranches = Storage.get('branches') || [];
            const members = allBranches.find(b => b.id === branch?.id)?.members || [];
            const me = members.find(m => m.userId === user.id);
            return ch.allowedRoles.includes(me?.role);
        };

        const PERM_ROLES = [
            { value: 'pharmacist',          label: 'Pharmacist' },
            { value: 'act_pharmacist',      label: 'ACT Pharmacist' },
            { value: 'pharmacy_technician', label: 'Pharmacy Technician' },
            { value: 'dispenser',           label: 'Dispenser' },
            { value: 'counter_assistant',   label: 'Counter Assistant' },
            { value: 'manager',             label: 'Manager' },
            { value: 'trainee_technician',  label: 'Trainee Technician' },
            { value: 'medicines_counter',   label: 'Medicines Counter' },
            { value: 'admin_staff',         label: 'Admin Staff' },
            { value: 'other',               label: 'Other' },
        ];

        const togglePermRole = (val) =>
            setChAllowedRoles(prev => prev.includes(val) ? prev.filter(r => r !== val) : [...prev, val]);

        return (
            <div className="animate-fadeIn" style={{ height: 'calc(100vh - 140px)' }}>
                <div className="relative flex h-full bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 overflow-hidden shadow-sm">

                    {/* ── SIDEBAR ── */}
                    <div className={`${showSidebar ? 'flex' : 'hidden'} sm:flex flex-col bg-gray-900 dark:bg-gray-950 w-full sm:w-52 flex-shrink-0 absolute sm:relative inset-0 sm:inset-auto z-10`}>

                        {/* Sidebar header */}
                        <div className="px-3 py-3 border-b border-gray-700">
                            <h3 className="text-white font-bold text-sm truncate">{branch?.name || 'Team'}</h3>
                            <p className="text-gray-400 text-xs mt-0.5">Pharmacy channels</p>
                        </div>

                        {/* Channels label + create button */}
                        <div className="flex items-center justify-between px-3 pt-4 pb-1">
                            <span className="text-gray-400 text-xs font-semibold uppercase tracking-wider">Channels</span>
                            {isAdmin && (
                                <button
                                    onClick={() => { setShowCreateCh(true); setNewChName(''); setNewChDesc(''); setChError(''); }}
                                    className="text-gray-400 hover:text-white transition-colors"
                                    title="Create channel"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            )}
                        </div>

                        {/* Channel list */}
                        <div className="flex-1 overflow-y-auto px-2 pb-4 space-y-0.5">
                            {channels.map(ch => {
                                const hasAccess = canAccessChannel(ch);
                                const isActive  = activeChannel?.id === ch.id;
                                const isLocked  = !hasAccess;
                                return (
                                <div
                                    key={ch.id}
                                    className={`group flex items-center justify-between px-2 py-1.5 rounded-lg transition-all
                                        ${isLocked
                                            ? 'opacity-40 cursor-not-allowed'
                                            : isActive
                                                ? 'bg-gray-600 text-white cursor-pointer'
                                                : 'text-gray-400 hover:bg-gray-700 hover:text-gray-200 cursor-pointer'
                                        }`}
                                    onClick={() => { if (!isLocked) { setActiveChannel(ch); setShowSidebar(false); } }}
                                    title={isLocked ? 'You do not have permission to access this channel' : ''}
                                >
                                    <span className="flex items-center gap-1.5 text-sm min-w-0">
                                        {isLocked
                                            ? <svg className="w-3.5 h-3.5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                            : <span className="text-gray-500 text-base flex-shrink-0">#</span>
                                        }
                                        <span className="truncate">{ch.name}</span>
                                    </span>
                                    {isAdmin && (
                                        <button
                                            onClick={e => { e.stopPropagation(); openEdit(ch); }}
                                            className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-white transition-all flex-shrink-0 ml-1"
                                            title="Edit channel"
                                        >
                                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                                );
                            })}
                        </div>

                        {/* User info at bottom */}
                        <div className="px-3 py-3 border-t border-gray-700 flex items-center gap-2">
                            <div className="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                style={{background: 'linear-gradient(135deg, #003087, #005EB8)'}}>
                                {user.name.charAt(0).toUpperCase()}
                            </div>
                            <div className="min-w-0">
                                <p className="text-white text-xs font-semibold truncate">{user.name}</p>
                                <p className="text-gray-400 text-xs truncate">{isAdmin ? 'Admin' : 'Staff'}</p>
                            </div>
                        </div>
                    </div>

                    {/* ── CHAT AREA ── */}
                    <div className="flex-1 flex flex-col min-w-0">

                        {/* Channel header */}
                        <div className="flex items-center gap-3 px-4 py-3 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                            {/* Mobile: back to channels */}
                            <button
                                onClick={() => setShowSidebar(true)}
                                className="sm:hidden text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors mr-1"
                            >
                                <Icon.Back />
                            </button>
                            <span className="text-gray-400 dark:text-gray-500 text-lg font-bold">#</span>
                            <div className="flex-1 min-w-0">
                                <h3 className="font-bold text-gray-800 dark:text-white text-sm truncate">
                                    {activeChannel?.name || 'Select a channel'}
                                </h3>
                                {activeChannel?.description && (
                                    <p className="text-xs text-gray-500 dark:text-gray-400 truncate">{activeChannel.description}</p>
                                )}
                            </div>
                            {/* Mobile: show channels */}
                            <button
                                onClick={() => setShowSidebar(true)}
                                className="sm:hidden flex items-center gap-1 text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors text-xs font-medium"
                            >
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16"/></svg>
                                Channels
                            </button>
                        </div>

                        {/* Confidentiality warning */}
                        {!confAck && (
                        <div className="flex-shrink-0 mx-4 mt-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl px-3 py-3">
                            <div className="flex items-start gap-2 mb-2">
                                <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                </svg>
                                <div className="flex-1">
                                    <p className="text-xs font-semibold text-red-700 dark:text-red-400">Confidentiality Notice</p>
                                    <p className="text-xs text-red-600 dark:text-red-400 mt-0.5">Never share patient names, NHS numbers, prescriptions, addresses, or any patient-identifiable information in this chat. This is a professional team channel monitored for compliance.</p>
                                </div>
                            </div>
                            <button
                                onClick={handleConfAck}
                                className="w-full py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-xs font-semibold transition-colors"
                            >
                                I Understand
                            </button>
                        </div>
                        )}

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto px-4 py-3 space-y-1 min-h-0">
                            {messages.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-center py-8">
                                    <div className="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-3 text-gray-400 text-xl font-bold">#</div>
                                    <p className="font-semibold text-gray-600 dark:text-gray-400">Welcome to #{activeChannel?.name}!</p>
                                    <p className="text-sm text-gray-400 dark:text-gray-500 mt-1">This is the start of the channel.</p>
                                    <div className="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl max-w-xs">
                                        <p className="text-xs text-amber-700 dark:text-amber-400 font-medium">⚠ Reminder: Do not share any patient information here.</p>
                                    </div>
                                </div>
                            ) : (
                                withDividers.map(item => {
                                    if (item.type === 'divider') {
                                        return (
                                            <div key={item.id} className="flex items-center gap-3 py-3">
                                                <div className="flex-1 h-px bg-gray-100 dark:bg-gray-700" />
                                                <span className="text-xs text-gray-400 dark:text-gray-500 font-medium flex-shrink-0 bg-white dark:bg-gray-800 px-2">{item.label}</span>
                                                <div className="flex-1 h-px bg-gray-100 dark:bg-gray-700" />
                                            </div>
                                        );
                                    }
                                    const isMe = item.userId === user.id;
                                    return (
                                        <div key={item.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} mb-2`}>
                                            <div className={`max-w-[78%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                                {!isMe && (
                                                    <span className="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1 ml-1">{item.userName}</span>
                                                )}
                                                <div
                                                    className={`px-4 py-2.5 rounded-2xl text-sm leading-relaxed shadow-sm
                                                        ${isMe
                                                            ? 'text-white rounded-br-sm'
                                                            : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-bl-sm'
                                                        }`}
                                                    style={isMe ? { background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)' } : {}}
                                                >
                                                    {item.text}
                                                </div>
                                                <span className={`text-xs text-gray-400 dark:text-gray-500 mt-1 ${isMe ? 'mr-1' : 'ml-1'}`}>
                                                    {formatTime(item.timestamp)}
                                                </span>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            <div ref={bottomRef} />
                        </div>

                        {/* Input */}
                        <div className="flex-shrink-0 px-4 pb-4 pt-2 border-t border-gray-100 dark:border-gray-700">
                            {activeChannel && !canAccessChannel(activeChannel) ? (
                                <div className="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-xl px-4 py-3">
                                    <svg className="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                    <p className="text-sm text-gray-400 dark:text-gray-500">You don't have permission to post in this channel.</p>
                                </div>
                            ) : (
                            <div className="flex items-end gap-2">
                                <textarea
                                    value={text}
                                    onChange={e => setText(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    className="input-field flex-1 resize-none min-h-[44px] max-h-28 py-3 leading-relaxed"
                                    placeholder={`Message #${activeChannel?.name || 'channel'}...`}
                                    rows={1}
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={!text.trim()}
                                    className="btn-primary w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 disabled:opacity-40"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                </button>
                            </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* ── CREATE CHANNEL MODAL ── */}
                {showCreateCh && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowCreateCh(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Create Channel</h3>
                                <button onClick={() => setShowCreateCh(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleCreateChannel} className="p-5 space-y-4">
                                {chError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{chError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Channel Name *</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">#</span>
                                        <input type="text" value={newChName} onChange={e => setNewChName(e.target.value)} className="input-field pl-7" placeholder="e.g. general" autoFocus />
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1">Lowercase letters, numbers and hyphens only</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
                                    <input type="text" value={newChDesc} onChange={e => setNewChDesc(e.target.value)} className="input-field" placeholder="What is this channel for?" />
                                </div>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setShowCreateCh(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Create</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* ── EDIT CHANNEL MODAL ── */}
                {editingCh && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setEditingCh(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Edit #{editingCh.name}</h3>
                                <button onClick={() => setEditingCh(null)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleEditChannel} className="p-5 space-y-4">
                                {chError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{chError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Channel Name *</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">#</span>
                                        <input type="text" value={newChName} onChange={e => setNewChName(e.target.value)} className="input-field pl-7" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
                                    <input type="text" value={newChDesc} onChange={e => setNewChDesc(e.target.value)} className="input-field" placeholder="What is this channel for?" />
                                </div>

                                {/* Role permissions */}
                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Who can access this channel?</label>
                                        {chAllowedRoles.length > 0 && (
                                            <button type="button" onClick={() => setChAllowedRoles([])} className="text-xs text-blue-500 hover:text-blue-600 dark:text-blue-400">
                                                Clear (everyone)
                                            </button>
                                        )}
                                    </div>
                                    <div className={`rounded-xl border p-1 space-y-0.5 ${chAllowedRoles.length === 0 ? 'border-gray-200 dark:border-gray-600' : 'border-blue-200 dark:border-blue-700 bg-blue-50 dark:bg-blue-900/10'}`}>
                                        <p className="text-xs text-gray-400 dark:text-gray-500 px-2 pt-1 pb-0.5">
                                            {chAllowedRoles.length === 0 ? 'No restriction — all staff can see this channel.' : `Restricted to ${chAllowedRoles.length} role${chAllowedRoles.length > 1 ? 's' : ''} (+ admins always).`}
                                        </p>
                                        {PERM_ROLES.map(r => (
                                            <button
                                                key={r.value}
                                                type="button"
                                                onClick={() => togglePermRole(r.value)}
                                                className={`w-full flex items-center justify-between px-3 py-2 rounded-lg transition-colors text-left ${chAllowedRoles.includes(r.value) ? 'bg-blue-100 dark:bg-blue-900/30' : 'hover:bg-gray-100 dark:hover:bg-gray-700/50'}`}
                                            >
                                                <span className="text-sm text-gray-700 dark:text-gray-300">{r.label}</span>
                                                <div className={`w-4 h-4 rounded border-2 flex items-center justify-center flex-shrink-0 transition-all ${chAllowedRoles.includes(r.value) ? 'bg-blue-500 border-blue-500' : 'border-gray-300 dark:border-gray-500'}`}>
                                                    {chAllowedRoles.includes(r.value) && (
                                                        <svg className="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>
                                                    )}
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                <div className="flex gap-3">
                                    <button
                                        type="button"
                                        onClick={() => handleDeleteChannel(editingCh)}
                                        className="px-4 py-3 rounded-xl border border-red-300 dark:border-red-700 text-red-600 dark:text-red-400 font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                    >
                                        Delete
                                    </button>
                                    <button type="button" onClick={() => setEditingCh(null)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Save</button>
                                </div>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── HANDOVER TAB ──────────────────────────────────────────────────────────
    function HandoverTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;

        const [notes,      setNotes]      = useState(Storage.get(`handover_${branchId}`) || []);
        const [filter,     setFilter]     = useState('all');
        const [showCreate, setShowCreate] = useState(false);
        const [newNote,    setNewNote]    = useState({ shift: 'morning', priority: 'normal', content: '' });
        const [error,      setError]      = useState('');

        const saveNotes = (updated) => {
            setNotes(updated);
            Storage.set(`handover_${branchId}`, updated);
        };

        const handleCreate = (e) => {
            e.preventDefault();
            setError('');
            if (!newNote.content.trim()) { setError('Please enter a note'); return; }
            const note = {
                id:          'hov_' + Date.now(),
                shift:       newNote.shift,
                priority:    newNote.priority,
                content:     newNote.content.trim(),
                createdBy:   user.id,
                createdByName: user.name,
                createdAt:   new Date().toISOString(),
                readBy:      []
            };
            saveNotes([note, ...notes]);
            setNewNote({ shift: 'morning', priority: 'normal', content: '' });
            setShowCreate(false);
        };

        const markAsRead = (noteId) => {
            const updated = notes.map(n => {
                if (n.id !== noteId) return n;
                const alreadyRead = n.readBy?.find(r => r.userId === user.id);
                if (alreadyRead) return n;
                return {
                    ...n,
                    readBy: [...(n.readBy || []), {
                        userId:   user.id,
                        userName: user.name,
                        readAt:   new Date().toISOString()
                    }]
                };
            });
            saveNotes(updated);
        };

        const deleteNote = (noteId) => {
            if (!window.confirm('Delete this handover note?')) return;
            saveNotes(notes.filter(n => n.id !== noteId));
        };

        const shifts = ['all', 'morning', 'afternoon', 'night'];

        const filtered = filter === 'all' ? notes : notes.filter(n => n.shift === filter);

        const priorityStyle = {
            urgent:    { bar: 'bg-red-500',    badge: 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400',    label: 'Urgent',    card: 'border-l-4 border-red-500' },
            important: { bar: 'bg-amber-500',  badge: 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400', label: 'Important', card: 'border-l-4 border-amber-500' },
            normal:    { bar: 'bg-blue-400',   badge: 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400',  label: 'Normal',    card: 'border-l-4 border-blue-300' },
        };

        const shiftIcon = { morning: '🌅', afternoon: '☀️', night: '🌙' };

        const formatTime = (iso) => new Date(iso).toLocaleString('en-GB', {
            day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
        });

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Handover</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">{notes.length} note{notes.length !== 1 ? 's' : ''} total</p>
                    </div>
                    <button
                        onClick={() => setShowCreate(true)}
                        className="btn-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                    >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Add Note
                    </button>
                </div>

                {/* Warning banner */}
                <div className="flex items-start gap-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl px-3 py-2.5">
                    <svg className="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                    </svg>
                    <p className="text-xs text-amber-700 dark:text-amber-400">Do not include patient names, NHS numbers or any patient-identifiable information in handover notes.</p>
                </div>

                {/* Shift filter */}
                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
                    {shifts.map(s => (
                        <button
                            key={s}
                            onClick={() => setFilter(s)}
                            className={`px-4 py-2 rounded-xl text-sm font-medium capitalize flex-shrink-0 transition-all
                                ${filter === s
                                    ? 'text-white shadow-sm'
                                    : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'
                                }`}
                            style={filter === s ? {background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'} : {}}
                        >
                            {s !== 'all' && shiftIcon[s] + ' '}{s === 'all' ? 'All Shifts' : s.charAt(0).toUpperCase() + s.slice(1)}
                        </button>
                    ))}
                </div>

                {/* Notes list */}
                {filtered.length === 0 ? (
                    <div className="bg-white dark:bg-gray-800 rounded-2xl p-10 text-center border border-gray-100 dark:border-gray-700">
                        <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-400">
                            <Icon.Handover />
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 font-medium">No handover notes</p>
                        <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">Tap "Add Note" to leave a note for the next shift.</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {filtered.map(note => {
                            const p       = priorityStyle[note.priority] || priorityStyle.normal;
                            const hasRead = note.readBy?.find(r => r.userId === user.id);

                            return (
                                <div
                                    key={note.id}
                                    className={`bg-white dark:bg-gray-800 rounded-2xl shadow-sm overflow-hidden ${p.card} ${note.priority === 'urgent' ? 'ring-1 ring-red-200 dark:ring-red-900' : ''}`}
                                >
                                    {/* Top row */}
                                    <div className="px-4 pt-4 pb-3">
                                        <div className="flex items-start justify-between gap-2 mb-2">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className={`text-xs font-semibold px-2.5 py-1 rounded-full ${p.badge}`}>
                                                    {p.label}
                                                </span>
                                                <span className="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2.5 py-1 rounded-full capitalize">
                                                    {shiftIcon[note.shift]} {note.shift}
                                                </span>
                                            </div>
                                            {isAdmin && (
                                                <button
                                                    onClick={() => deleteNote(note.id)}
                                                    className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors flex-shrink-0"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            )}
                                        </div>

                                        {/* Note content */}
                                        <p className="text-sm text-gray-800 dark:text-white leading-relaxed whitespace-pre-wrap">{note.content}</p>

                                        {/* Meta */}
                                        <p className="text-xs text-gray-400 dark:text-gray-500 mt-2">
                                            Written by <span className="font-medium text-gray-500 dark:text-gray-400">{note.createdByName}</span> · {formatTime(note.createdAt)}
                                        </p>
                                    </div>

                                    {/* Read by section */}
                                    <div className="px-4 pb-3 border-t border-gray-100 dark:border-gray-700 pt-3">
                                        <div className="flex items-center justify-between gap-3">
                                            {/* Who has read it */}
                                            <div className="flex-1 min-w-0">
                                                {note.readBy?.length > 0 ? (
                                                    <div>
                                                        <p className="text-xs text-gray-400 dark:text-gray-500 mb-1">Read by:</p>
                                                        <div className="flex flex-wrap gap-1.5">
                                                            {note.readBy.map((r, i) => (
                                                                <span key={i} className="inline-flex items-center gap-1 text-xs bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 px-2 py-0.5 rounded-full border border-green-100 dark:border-green-800">
                                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                                                                    </svg>
                                                                    {r.userName}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <p className="text-xs text-gray-400 dark:text-gray-500 italic">No one has read this yet</p>
                                                )}
                                            </div>

                                            {/* Mark as read button */}
                                            {!hasRead ? (
                                                <button
                                                    onClick={() => markAsRead(note.id)}
                                                    className="flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-semibold text-white transition-all hover:opacity-90 active:scale-95"
                                                    style={{background: 'linear-gradient(135deg, #009639 0%, #00B84A 100%)'}}
                                                >
                                                    Mark as Read
                                                </button>
                                            ) : (
                                                <span className="flex-shrink-0 flex items-center gap-1 text-xs font-medium text-green-600 dark:text-green-400">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
                                                    </svg>
                                                    Read
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}

                {/* Create note modal */}
                {showCreate && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowCreate(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">New Handover Note</h3>
                                <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleCreate} className="p-5 space-y-4">
                                {error && (
                                    <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{error}</div>
                                )}

                                {/* Warning inside modal */}
                                <div className="flex items-start gap-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl px-3 py-2">
                                    <svg className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
                                    <p className="text-xs text-red-700 dark:text-red-400">Do not include any patient names, NHS numbers, or identifiable information.</p>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Shift</label>
                                        <select value={newNote.shift} onChange={e => setNewNote({...newNote, shift: e.target.value})} className="input-field">
                                            <option value="morning">🌅 Morning</option>
                                            <option value="afternoon">☀️ Afternoon</option>
                                            <option value="night">🌙 Night</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Priority</label>
                                        <select value={newNote.priority} onChange={e => setNewNote({...newNote, priority: e.target.value})} className="input-field">
                                            <option value="normal">Normal</option>
                                            <option value="important">Important</option>
                                            <option value="urgent">🔴 Urgent</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Note *</label>
                                    <textarea
                                        value={newNote.content}
                                        onChange={e => setNewNote({...newNote, content: e.target.value})}
                                        className="input-field resize-none"
                                        rows={5}
                                        placeholder="Write your handover note here..."
                                        autoFocus
                                    />
                                </div>

                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setShowCreate(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Add Note</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── SCHEDULE TAB ──────────────────────────────────────────────────────────
    function ScheduleTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;
        const members  = branch?.members || [];

        const [shifts,     setShifts]     = useState(Storage.get(`schedule_${branchId}`) || []);
        const [weekOffset, setWeekOffset] = useState(0);
        const [showCreate, setShowCreate] = useState(false);
        const [newShift,   setNewShift]   = useState({ staffName: '', day: 'monday', startTime: '09:00', endTime: '17:00', role: 'Pharmacist' });
        const [error,      setError]      = useState('');

        const saveShifts = (updated) => {
            setShifts(updated);
            Storage.set(`schedule_${branchId}`, updated);
        };

        // Get the Monday of the current week + offset
        const getWeekDates = (offset) => {
            const now  = new Date();
            const day  = now.getDay();
            const diff = (day === 0 ? -6 : 1 - day);
            const monday = new Date(now);
            monday.setDate(now.getDate() + diff + offset * 7);
            return Array.from({ length: 7 }, (_, i) => {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                return d;
            });
        };

        const weekDates  = getWeekDates(weekOffset);
        const dayNames   = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
        const dayLabels  = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

        const isToday = (date) => {
            const t = new Date();
            return date.toDateString() === t.toDateString();
        };

        const weekLabel = () => {
            const start = weekDates[0];
            const end   = weekDates[6];
            const fmt   = d => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            if (weekOffset === 0) return `This Week · ${fmt(start)} – ${fmt(end)}`;
            if (weekOffset === 1) return `Next Week · ${fmt(start)} – ${fmt(end)}`;
            if (weekOffset === -1) return `Last Week · ${fmt(start)} – ${fmt(end)}`;
            return `${fmt(start)} – ${fmt(end)}`;
        };

        const handleCreate = (e) => {
            e.preventDefault();
            setError('');
            if (!newShift.staffName.trim()) { setError('Please select a staff member'); return; }
            if (!newShift.startTime || !newShift.endTime) { setError('Please set start and end times'); return; }
            if (newShift.startTime >= newShift.endTime) { setError('End time must be after start time'); return; }
            const shift = {
                id:        'shf_' + Date.now(),
                staffName: newShift.staffName.trim(),
                day:       newShift.day,
                startTime: newShift.startTime,
                endTime:   newShift.endTime,
                role:      newShift.role,
                week:      weekOffset,
                createdBy: user.id
            };
            saveShifts([...shifts, shift]);
            setNewShift({ staffName: '', day: 'monday', startTime: '09:00', endTime: '17:00', role: 'Pharmacist' });
            setShowCreate(false);
        };

        const deleteShift = (shiftId) => {
            if (!window.confirm('Remove this shift?')) return;
            saveShifts(shifts.filter(s => s.id !== shiftId));
        };

        const roleColors = {
            'Pharmacist':            'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400',
            'Pharmacy Technician':   'bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400',
            'Dispenser':             'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400',
            'Counter Assistant':     'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400',
            'Manager':               'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400',
            'Staff':                 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400',
        };

        // Get all users for the dropdown
        const allUsers = Storage.get('users') || [];
        const branchUsers = members.map(m => {
            const u = allUsers.find(u => u.id === m.userId);
            return u ? { name: u.name, role: m.role } : null;
        }).filter(Boolean);

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Schedule</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">Staff rota</p>
                    </div>
                    {isAdmin && (
                        <button
                            onClick={() => setShowCreate(true)}
                            className="btn-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            Add Shift
                        </button>
                    )}
                </div>

                {/* Week navigator */}
                <div className="flex items-center justify-between bg-white dark:bg-gray-800 rounded-2xl px-4 py-3 border border-gray-100 dark:border-gray-700 shadow-sm">
                    <button
                        onClick={() => setWeekOffset(weekOffset - 1)}
                        className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div className="text-center">
                        <p className="text-sm font-semibold text-gray-800 dark:text-white">{weekLabel()}</p>
                        {weekOffset !== 0 && (
                            <button onClick={() => setWeekOffset(0)} className="text-xs text-blue-600 dark:text-blue-400 hover:underline mt-0.5">
                                Back to this week
                            </button>
                        )}
                    </div>
                    <button
                        onClick={() => setWeekOffset(weekOffset + 1)}
                        className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                {/* Day cards */}
                <div className="space-y-2">
                    {dayNames.map((day, idx) => {
                        const date       = weekDates[idx];
                        const dayShifts  = shifts.filter(s => s.day === day && s.week === weekOffset);
                        const today      = isToday(date);
                        const isWeekend  = idx >= 5;

                        return (
                            <div
                                key={day}
                                className={`bg-white dark:bg-gray-800 rounded-2xl border shadow-sm overflow-hidden
                                    ${today
                                        ? 'border-blue-300 dark:border-blue-600 ring-1 ring-blue-200 dark:ring-blue-700'
                                        : 'border-gray-100 dark:border-gray-700'
                                    }`}
                            >
                                {/* Day header */}
                                <div className={`flex items-center justify-between px-4 py-2.5
                                    ${today
                                        ? 'bg-blue-50 dark:bg-blue-900/20'
                                        : isWeekend
                                            ? 'bg-gray-50 dark:bg-gray-700/30'
                                            : 'bg-white dark:bg-gray-800'
                                    }`}
                                >
                                    <div className="flex items-center gap-2">
                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold
                                            ${today
                                                ? 'text-white'
                                                : 'text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700'
                                            }`}
                                            style={today ? {background: 'linear-gradient(135deg, #003087, #005EB8)'} : {}}
                                        >
                                            {date.getDate()}
                                        </div>
                                        <div>
                                            <span className={`text-sm font-semibold capitalize ${today ? 'text-blue-700 dark:text-blue-400' : 'text-gray-700 dark:text-gray-300'}`}>
                                                {dayLabels[idx]}
                                                {today && <span className="ml-1.5 text-xs font-medium text-blue-500 dark:text-blue-400">Today</span>}
                                            </span>
                                            <p className="text-xs text-gray-400 dark:text-gray-500">
                                                {date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' })}
                                            </p>
                                        </div>
                                    </div>
                                    <span className="text-xs text-gray-400 dark:text-gray-500">
                                        {dayShifts.length > 0 ? `${dayShifts.length} shift${dayShifts.length > 1 ? 's' : ''}` : 'No shifts'}
                                    </span>
                                </div>

                                {/* Shifts for this day */}
                                {dayShifts.length > 0 && (
                                    <div className="px-4 py-2 space-y-2 border-t border-gray-100 dark:border-gray-700">
                                        {dayShifts.map(shift => (
                                            <div key={shift.id} className="flex items-center justify-between gap-3 py-1">
                                                <div className="flex items-center gap-2.5 min-w-0 flex-1">
                                                    <div className="w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                                        style={{background: 'linear-gradient(135deg, #003087, #005EB8)'}}>
                                                        {shift.staffName.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div className="min-w-0">
                                                        <p className="text-sm font-medium text-gray-800 dark:text-white truncate">{shift.staffName}</p>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-gray-500 dark:text-gray-400">
                                                                {shift.startTime} – {shift.endTime}
                                                            </span>
                                                            <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${roleColors[shift.role] || roleColors['Staff']}`}>
                                                                {shift.role}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isAdmin && (
                                                    <button
                                                        onClick={() => deleteShift(shift.id)}
                                                        className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors flex-shrink-0"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                {/* Create shift modal */}
                {showCreate && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowCreate(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Add Shift</h3>
                                <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleCreate} className="p-5 space-y-4">
                                {error && (
                                    <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{error}</div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Staff Member *</label>
                                    {branchUsers.length > 0 ? (
                                        <select
                                            value={newShift.staffName}
                                            onChange={e => setNewShift({...newShift, staffName: e.target.value})}
                                            className="input-field"
                                        >
                                            <option value="">Select staff member...</option>
                                            {branchUsers.map((u, i) => (
                                                <option key={i} value={u.name}>{u.name}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <input
                                            type="text"
                                            value={newShift.staffName}
                                            onChange={e => setNewShift({...newShift, staffName: e.target.value})}
                                            className="input-field"
                                            placeholder="Staff member name"
                                        />
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Day</label>
                                    <select value={newShift.day} onChange={e => setNewShift({...newShift, day: e.target.value})} className="input-field">
                                        {dayNames.map((d, i) => <option key={d} value={d}>{dayLabels[i]} · {weekDates[i].toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</option>)}
                                    </select>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Start Time</label>
                                        <input type="time" value={newShift.startTime} onChange={e => setNewShift({...newShift, startTime: e.target.value})} className="input-field" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">End Time</label>
                                        <input type="time" value={newShift.endTime} onChange={e => setNewShift({...newShift, endTime: e.target.value})} className="input-field" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Role</label>
                                    <select value={newShift.role} onChange={e => setNewShift({...newShift, role: e.target.value})} className="input-field">
                                        {Object.keys(roleColors).map(r => <option key={r} value={r}>{r}</option>)}
                                    </select>
                                </div>

                                <div className="flex gap-3 pt-1">
                                    <button type="button" onClick={() => setShowCreate(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Add Shift</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── CALENDAR TAB ──────────────────────────────────────────────────────────
    function CalendarTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;
        const [events,     setEvents]     = useState(Storage.get(`events_${branchId}`) || []);
        const [view,       setView]       = useState('month');
        const [monthOffset, setMonthOffset] = useState(0);
        const [showCreate, setShowCreate] = useState(false);
        const [newEvent,   setNewEvent]   = useState({ title: '', date: '', time: '', description: '' });
        const [error,      setError]      = useState('');
        const [selected,   setSelected]   = useState(null);

        const saveEvents = (updated) => { setEvents(updated); Storage.set(`events_${branchId}`, updated); };

        const today = new Date();

        const getMonthData = (offset) => {
            const d = new Date(today.getFullYear(), today.getMonth() + offset, 1);
            return { year: d.getFullYear(), month: d.getMonth(), label: d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' }) };
        };

        const { year, month, label } = getMonthData(monthOffset);

        const firstDay  = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startPad  = firstDay === 0 ? 6 : firstDay - 1;
        const totalCells = Math.ceil((startPad + daysInMonth) / 7) * 7;

        const isToday = (d) => d === today.getDate() && month === today.getMonth() && year === today.getFullYear();

        const eventsOnDay = (d) => {
            const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            return events.filter(e => e.date === key);
        };

        const handleCreate = (e) => {
            e.preventDefault();
            setError('');
            if (!newEvent.title.trim()) { setError('Please enter a title'); return; }
            if (!newEvent.date)         { setError('Please select a date'); return; }
            const ev = {
                id:          'ev_' + Date.now(),
                title:       newEvent.title.trim(),
                date:        newEvent.date,
                time:        newEvent.time,
                description: newEvent.description.trim(),
                createdBy:   user.id,
                createdByName: user.name,
                createdAt:   new Date().toISOString()
            };
            saveEvents([...events, ev]);
            setNewEvent({ title: '', date: '', time: '', description: '' });
            setShowCreate(false);
        };

        const deleteEvent = (evId) => {
            if (!window.confirm('Delete this event?')) return;
            saveEvents(events.filter(e => e.id !== evId));
            setSelected(null);
        };

        // Upcoming events (today + future), sorted
        const upcoming = events
            .filter(e => e.date >= today.toISOString().split('T')[0])
            .sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));

        const formatDate = (dateStr) => new Date(dateStr + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' });

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Calendar</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">{events.length} event{events.length !== 1 ? 's' : ''}</p>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="flex bg-gray-100 dark:bg-gray-800 rounded-xl p-1">
                            {['month','list'].map(v => (
                                <button key={v} onClick={() => setView(v)}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium capitalize transition-all
                                        ${view === v ? 'bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-400 shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>
                                    {v}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setShowCreate(true)} className="btn-primary px-3 py-2 rounded-xl text-sm font-semibold flex items-center gap-1">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            Add
                        </button>
                    </div>
                </div>

                {view === 'month' && (
                    <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
                        {/* Month nav */}
                        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                            <button onClick={() => setMonthOffset(monthOffset - 1)} className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <div className="text-center">
                                <p className="font-bold text-gray-800 dark:text-white text-sm">{label}</p>
                                {monthOffset !== 0 && <button onClick={() => setMonthOffset(0)} className="text-xs text-blue-600 dark:text-blue-400 hover:underline">Today</button>}
                            </div>
                            <button onClick={() => setMonthOffset(monthOffset + 1)} className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </div>

                        {/* Day headers */}
                        <div className="grid grid-cols-7 border-b border-gray-100 dark:border-gray-700">
                            {['Mo','Tu','We','Th','Fr','Sa','Su'].map(d => (
                                <div key={d} className="py-2 text-center text-xs font-semibold text-gray-400 dark:text-gray-500">{d}</div>
                            ))}
                        </div>

                        {/* Calendar grid */}
                        <div className="grid grid-cols-7">
                            {Array.from({ length: totalCells }, (_, i) => {
                                const dayNum = i - startPad + 1;
                                const valid  = dayNum >= 1 && dayNum <= daysInMonth;
                                const dayEvs = valid ? eventsOnDay(dayNum) : [];
                                const tday   = valid && isToday(dayNum);
                                const colIdx = i % 7;
                                const isWknd = colIdx === 5 || colIdx === 6;

                                return (
                                    <div
                                        key={i}
                                        onClick={() => valid && dayEvs.length > 0 && setSelected({ day: dayNum, events: dayEvs })}
                                        className={`min-h-[52px] p-1.5 border-b border-r border-gray-50 dark:border-gray-700/50 transition-colors
                                            ${valid && dayEvs.length > 0 ? 'cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/10' : ''}
                                            ${!valid ? 'bg-gray-50/50 dark:bg-gray-800/50' : ''}
                                            ${isWknd && valid ? 'bg-gray-50/80 dark:bg-gray-700/20' : ''}
                                        `}
                                    >
                                        {valid && (
                                            <>
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium mx-auto mb-0.5
                                                    ${tday ? 'text-white' : 'text-gray-700 dark:text-gray-300'}`}
                                                    style={tday ? {background:'linear-gradient(135deg,#003087,#005EB8)'} : {}}>
                                                    {dayNum}
                                                </div>
                                                <div className="space-y-0.5">
                                                    {dayEvs.slice(0,2).map(ev => (
                                                        <div key={ev.id} className="text-xs bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 rounded px-1 truncate leading-tight py-0.5">
                                                            {ev.time && <span className="opacity-70">{ev.time} </span>}{ev.title}
                                                        </div>
                                                    ))}
                                                    {dayEvs.length > 2 && (
                                                        <div className="text-xs text-blue-500 dark:text-blue-400 px-1">+{dayEvs.length - 2} more</div>
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* List view */}
                {view === 'list' && (
                    <div className="space-y-2">
                        {upcoming.length === 0 ? (
                            <div className="bg-white dark:bg-gray-800 rounded-2xl p-10 text-center border border-gray-100 dark:border-gray-700">
                                <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-400"><Icon.Calendar /></div>
                                <p className="text-gray-600 dark:text-gray-400 font-medium">No upcoming events</p>
                                <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">Tap "+ Add" to create an event.</p>
                            </div>
                        ) : upcoming.map(ev => (
                            <div key={ev.id} className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm p-4 flex items-start gap-3">
                                <div className="w-12 h-12 rounded-xl flex flex-col items-center justify-center flex-shrink-0 text-white" style={{background:'linear-gradient(135deg,#003087,#005EB8)'}}>
                                    <span className="text-xs font-medium leading-tight">{new Date(ev.date+'T00:00:00').toLocaleDateString('en-GB',{month:'short'})}</span>
                                    <span className="text-lg font-bold leading-tight">{new Date(ev.date+'T00:00:00').getDate()}</span>
                                </div>
                                <div className="flex-1 min-w-0">
                                    <p className="font-semibold text-gray-800 dark:text-white text-sm">{ev.title}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">{formatDate(ev.date)}{ev.time && ` · ${ev.time}`}</p>
                                    {ev.description && <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{ev.description}</p>}
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">Added by {ev.createdByName}</p>
                                </div>
                                {isAdmin && (
                                    <button onClick={() => deleteEvent(ev.id)} className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors flex-shrink-0">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                )}

                {/* Day events popup */}
                {selected && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setSelected(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="font-bold text-gray-800 dark:text-white">
                                    {new Date(year, month, selected.day).toLocaleDateString('en-GB',{weekday:'long', day:'numeric', month:'long'})}
                                </h3>
                                <button onClick={() => setSelected(null)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <div className="p-4 space-y-3">
                                {selected.events.map(ev => (
                                    <div key={ev.id} className="flex items-start justify-between gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                                        <div className="flex-1 min-w-0">
                                            <p className="font-semibold text-gray-800 dark:text-white text-sm">{ev.title}</p>
                                            {ev.time && <p className="text-xs text-blue-600 dark:text-blue-400 mt-0.5">{ev.time}</p>}
                                            {ev.description && <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{ev.description}</p>}
                                        </div>
                                        {isAdmin && (
                                            <button onClick={() => deleteEvent(ev.id)} className="text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 transition-colors flex-shrink-0">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {/* Create event modal */}
                {showCreate && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowCreate(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">New Event</h3>
                                <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleCreate} className="p-5 space-y-4">
                                {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{error}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Title *</label>
                                    <input type="text" value={newEvent.title} onChange={e => setNewEvent({...newEvent, title: e.target.value})} className="input-field" placeholder="Event title" autoFocus />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Date *</label>
                                        <input type="date" value={newEvent.date} onChange={e => setNewEvent({...newEvent, date: e.target.value})} className="input-field" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Time</label>
                                        <input type="time" value={newEvent.time} onChange={e => setNewEvent({...newEvent, time: e.target.value})} className="input-field" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
                                    <textarea value={newEvent.description} onChange={e => setNewEvent({...newEvent, description: e.target.value})} className="input-field resize-none" rows={3} placeholder="Optional details..." />
                                </div>
                                <div className="flex gap-3 pt-1">
                                    <button type="button" onClick={() => setShowCreate(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Add Event</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── NOTICES TAB ───────────────────────────────────────────────────────────
    function NoticesTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;
        const [notices,    setNotices]    = useState(Storage.get(`notices_${branchId}`) || []);
        const [showCreate, setShowCreate] = useState(false);
        const [newNotice,  setNewNotice]  = useState({ title: '', content: '', priority: 'info' });
        const [error,      setError]      = useState('');

        const saveNotices = (updated) => { setNotices(updated); Storage.set(`notices_${branchId}`, updated); };

        const handleCreate = (e) => {
            e.preventDefault();
            setError('');
            if (!newNotice.title.trim())   { setError('Please enter a title'); return; }
            if (!newNotice.content.trim()) { setError('Please enter the notice content'); return; }
            const notice = {
                id:          'ntc_' + Date.now(),
                title:       newNotice.title.trim(),
                content:     newNotice.content.trim(),
                priority:    newNotice.priority,
                pinned:      false,
                createdBy:   user.id,
                createdByName: user.name,
                createdAt:   new Date().toISOString()
            };
            saveNotices([notice, ...notices]);
            setNewNotice({ title: '', content: '', priority: 'info' });
            setShowCreate(false);
        };

        const togglePin = (noticeId) => {
            saveNotices(notices.map(n => n.id === noticeId ? { ...n, pinned: !n.pinned } : n));
        };

        const deleteNotice = (noticeId) => {
            if (!window.confirm('Delete this notice?')) return;
            saveNotices(notices.filter(n => n.id !== noticeId));
        };

        // Pinned first, then by date newest
        const sorted = [...notices].sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return new Date(b.createdAt) - new Date(a.createdAt);
        });

        const priorityConfig = {
            urgent:    { badge: 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400',    border: 'border-l-4 border-red-500',    ring: 'ring-1 ring-red-100 dark:ring-red-900',    icon: '🔴', label: 'Urgent' },
            important: { badge: 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400', border: 'border-l-4 border-amber-500', ring: '',                                          icon: '🟡', label: 'Important' },
            info:      { badge: 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400',  border: 'border-l-4 border-blue-400',   ring: '',                                          icon: 'ℹ️', label: 'Info' },
        };

        const formatDate = (iso) => new Date(iso).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Notices</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                            {notices.filter(n => n.pinned).length > 0
                                ? `${notices.filter(n => n.pinned).length} pinned · ${notices.length} total`
                                : `${notices.length} notice${notices.length !== 1 ? 's' : ''}`}
                        </p>
                    </div>
                    {isAdmin && (
                        <button
                            onClick={() => setShowCreate(true)}
                            className="btn-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            Post Notice
                        </button>
                    )}
                </div>

                {/* Empty state */}
                {notices.length === 0 ? (
                    <div className="bg-white dark:bg-gray-800 rounded-2xl p-10 text-center border border-gray-100 dark:border-gray-700">
                        <div className="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-400">
                            <Icon.Notices />
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 font-medium">No notices yet</p>
                        <p className="text-gray-400 dark:text-gray-500 text-sm mt-1">
                            {isAdmin ? 'Post a notice to keep your team informed.' : 'No notices have been posted yet.'}
                        </p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {sorted.map(notice => {
                            const p = priorityConfig[notice.priority] || priorityConfig.info;
                            return (
                                <div
                                    key={notice.id}
                                    className={`bg-white dark:bg-gray-800 rounded-2xl shadow-sm overflow-hidden ${p.border} ${p.ring}`}
                                >
                                    <div className="p-4">
                                        {/* Top row: badges + actions */}
                                        <div className="flex items-start justify-between gap-2 mb-2">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                {notice.pinned && (
                                                    <span className="inline-flex items-center gap-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2.5 py-1 rounded-full font-medium">
                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
                                                        </svg>
                                                        Pinned
                                                    </span>
                                                )}
                                                <span className={`text-xs font-semibold px-2.5 py-1 rounded-full ${p.badge}`}>
                                                    {p.icon} {p.label}
                                                </span>
                                            </div>

                                            {/* Admin actions */}
                                            {isAdmin && (
                                                <div className="flex items-center gap-1 flex-shrink-0">
                                                    <button
                                                        onClick={() => togglePin(notice.id)}
                                                        title={notice.pinned ? 'Unpin' : 'Pin to top'}
                                                        className={`p-1.5 rounded-lg transition-colors ${notice.pinned ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-300 dark:text-gray-600 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20'}`}
                                                    >
                                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
                                                        </svg>
                                                    </button>
                                                    <button
                                                        onClick={() => deleteNotice(notice.id)}
                                                        className="p-1.5 rounded-lg text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        {/* Title */}
                                        <h3 className="font-bold text-gray-800 dark:text-white mb-1.5">{notice.title}</h3>

                                        {/* Content */}
                                        <p className="text-sm text-gray-600 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">{notice.content}</p>

                                        {/* Footer */}
                                        <div className="flex items-center gap-1.5 mt-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                                            <div className="w-5 h-5 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                                style={{background:'linear-gradient(135deg,#003087,#005EB8)'}}>
                                                {notice.createdByName.charAt(0).toUpperCase()}
                                            </div>
                                            <p className="text-xs text-gray-400 dark:text-gray-500">
                                                Posted by <span className="font-medium text-gray-500 dark:text-gray-400">{notice.createdByName}</span> · {formatDate(notice.createdAt)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}

                {/* Create notice modal */}
                {showCreate && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowCreate(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Post Notice</h3>
                                <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <form onSubmit={handleCreate} className="p-5 space-y-4">
                                {error && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{error}</div>}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Title *</label>
                                    <input type="text" value={newNotice.title} onChange={e => setNewNotice({...newNotice, title: e.target.value})} className="input-field" placeholder="Notice title" autoFocus />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Priority</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {[
                                            { value: 'info',      label: 'Info',      color: 'border-blue-300 dark:border-blue-700',    active: 'bg-blue-500 border-blue-500 text-white' },
                                            { value: 'important', label: 'Important', color: 'border-amber-300 dark:border-amber-700',  active: 'bg-amber-500 border-amber-500 text-white' },
                                            { value: 'urgent',    label: 'Urgent',    color: 'border-red-300 dark:border-red-700',      active: 'bg-red-500 border-red-500 text-white' },
                                        ].map(opt => (
                                            <button
                                                key={opt.value}
                                                type="button"
                                                onClick={() => setNewNotice({...newNotice, priority: opt.value})}
                                                className={`py-2.5 rounded-xl border-2 text-sm font-semibold transition-all
                                                    ${newNotice.priority === opt.value
                                                        ? opt.active
                                                        : `${opt.color} text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700`
                                                    }`}
                                            >
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Content *</label>
                                    <textarea
                                        value={newNotice.content}
                                        onChange={e => setNewNotice({...newNotice, content: e.target.value})}
                                        className="input-field resize-none"
                                        rows={5}
                                        placeholder="Write your notice here..."
                                    />
                                </div>

                                <div className="flex gap-3 pt-1">
                                    <button type="button" onClick={() => setShowCreate(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Post</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── STAFF TAB ─────────────────────────────────────────────────────────────
    function StaffTab({ user, branch, isAdmin }) {
        const branchId = branch?.id;
        const [branches,   setBranches]   = useState(Storage.get('branches') || []);
        const [showInvite, setShowInvite] = useState(false);
        const [confirmRemove,     setConfirmRemove]     = useState(null);
        const [confirmRole,       setConfirmRole]       = useState(null);
        const [confirmAdmin,      setConfirmAdmin]      = useState(null);  // { member, user, makeAdmin }
        const [rolePickerMember,  setRolePickerMember]  = useState(null);  // member whose job role is being set

        const currentBranch = branches.find(b => b.id === branchId);
        const members       = currentBranch?.members || [];
        const pending       = currentBranch?.pendingRequests || [];
        const allUsers      = Storage.get('users') || [];

        const refreshBranch = () => setBranches(Storage.get('branches') || []);

        const approveRequest = (req) => {
            const branches = Storage.get('branches') || [];
            const updated  = branches.map(b => {
                if (b.id !== branchId) return b;
                const alreadyMember = b.members?.find(m => m.userId === req.userId);
                if (alreadyMember) return { ...b, pendingRequests: b.pendingRequests.filter(r => r.userId !== req.userId) };
                return {
                    ...b,
                    members: [...(b.members || []), { userId: req.userId, role: req.requestedRole || 'staff', joinedAt: new Date().toISOString() }],
                    pendingRequests: b.pendingRequests.filter(r => r.userId !== req.userId)
                };
            });
            Storage.set('branches', updated);
            // Update user record so they can log in
            const users = Storage.get('users') || [];
            const uIdx  = users.findIndex(u => u.id === req.userId);
            if (uIdx !== -1) {
                users[uIdx] = { ...users[uIdx], branchId, isAdmin: false };
                Storage.set('users', users);
            }
            setBranches(updated);
        };

        const denyRequest = (req) => {
            const branches = Storage.get('branches') || [];
            const updated  = branches.map(b => {
                if (b.id !== branchId) return b;
                return { ...b, pendingRequests: b.pendingRequests.filter(r => r.userId !== req.userId) };
            });
            Storage.set('branches', updated);
            setBranches(updated);
        };

        const getMemberUser = (m) => allUsers.find(u => u.id === m.userId);

        const handleRemove = (memberId) => {
            const updated = branches.map(b => {
                if (b.id !== branchId) return b;
                return { ...b, members: b.members.filter(m => m.userId !== memberId) };
            });
            Storage.set('branches', updated);
            setBranches(updated);
            // Also update the removed user's record
            const users = Storage.get('users') || [];
            const uIdx  = users.findIndex(u => u.id === memberId);
            if (uIdx !== -1 && users[uIdx].branchId === branchId) {
                users[uIdx] = { ...users[uIdx], branchId: null, chainId: null, isAdmin: false };
                Storage.set('users', users);
            }
            setConfirmRemove(null);
        };

        const handleRoleChange = (memberId, newJobRole) => {
            const updated = branches.map(b => {
                if (b.id !== branchId) return b;
                const updatedMembers = b.members.map(m =>
                    m.userId === memberId ? { ...m, role: newJobRole } : m
                );
                return { ...b, members: updatedMembers };
            });
            Storage.set('branches', updated);
            const users = Storage.get('users') || [];
            const uIdx  = users.findIndex(u => u.id === memberId);
            if (uIdx !== -1) {
                users[uIdx] = { ...users[uIdx], role: newJobRole };
                Storage.set('users', users);
            }
            setBranches(updated);
            setConfirmRole(null);
        };

        const handleAdminToggle = (memberId, makeAdmin) => {
            const updated = branches.map(b => {
                if (b.id !== branchId) return b;
                const updatedAdmins = makeAdmin
                    ? [...new Set([...b.admins, memberId])]
                    : b.admins.filter(id => id !== memberId);
                return { ...b, admins: updatedAdmins };
            });
            Storage.set('branches', updated);
            const users = Storage.get('users') || [];
            const uIdx  = users.findIndex(u => u.id === memberId);
            if (uIdx !== -1) {
                users[uIdx] = { ...users[uIdx], isAdmin: makeAdmin };
                Storage.set('users', users);
            }
            setBranches(updated);
            setConfirmAdmin(null);
        };

        // Pharmacy job roles — separate from admin permission
        const JOB_ROLES = [
            { value: 'pharmacist',          label: 'Pharmacist',            badge: 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400' },
            { value: 'act_pharmacist',      label: 'ACT Pharmacist',        badge: 'bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-400' },
            { value: 'pharmacy_technician', label: 'Pharmacy Technician',   badge: 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' },
            { value: 'dispenser',           label: 'Dispenser',             badge: 'bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400' },
            { value: 'counter_assistant',   label: 'Counter Assistant',     badge: 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400' },
            { value: 'manager',             label: 'Manager',               badge: 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400' },
            { value: 'trainee_technician',  label: 'Trainee Technician',    badge: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400' },
            { value: 'medicines_counter',   label: 'Medicines Counter',     badge: 'bg-lime-100 dark:bg-lime-900/30 text-lime-700 dark:text-lime-400' },
            { value: 'admin_staff',         label: 'Admin Staff',           badge: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300' },
            { value: 'other',               label: 'Other',                 badge: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' },
        ];
        const getRoleConfig = (roleVal) => JOB_ROLES.find(r => r.value === roleVal) || { label: 'Staff', badge: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' };

        const formatJoined = (iso) => new Date(iso).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 dark:text-white">Staff</h2>
                        <p className="text-xs text-gray-500 dark:text-gray-400">{members.length} member{members.length !== 1 ? 's' : ''} · {currentBranch?.name}</p>
                    </div>
                    {isAdmin && (
                        <button
                            onClick={() => setShowInvite(true)}
                            className="btn-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                            Invite
                        </button>
                    )}
                </div>

                {/* Stats row */}
                <div className="grid grid-cols-3 gap-3">
                    {[
                        { label: 'Total',   value: members.length,                                 color: 'text-blue-600 dark:text-blue-400' },
                        { label: 'Admins',  value: (currentBranch?.admins?.length || 0), color: 'text-purple-600 dark:text-purple-400' },
                        { label: 'Pending', value: pending.length,                                 color: pending.length > 0 ? 'text-amber-500 dark:text-amber-400' : 'text-green-600 dark:text-green-400' },
                    ].map(s => (
                        <div key={s.label} className="bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-100 dark:border-gray-700 text-center shadow-sm">
                            <p className={`text-2xl font-bold ${s.color}`}>{s.value}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{s.label}</p>
                        </div>
                    ))}
                </div>

                {/* Pending join requests — admin only */}
                {isAdmin && pending.length > 0 && (
                    <div className="bg-white dark:bg-gray-800 rounded-2xl border border-amber-200 dark:border-amber-800 shadow-sm overflow-hidden mb-4">
                        <div className="px-4 py-3 border-b border-amber-100 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20 flex items-center gap-2">
                            <svg className="w-4 h-4 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                            </svg>
                            <h3 className="text-sm font-semibold text-amber-700 dark:text-amber-400">
                                Pending Join Requests ({pending.length})
                            </h3>
                        </div>
                        {pending.map((req, idx) => (
                            <div key={req.userId} className={`flex items-center gap-3 px-4 py-3 ${idx < pending.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : ''}`}>
                                {/* Avatar */}
                                <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0 bg-amber-400">
                                    {(req.userName || '?').charAt(0).toUpperCase()}
                                </div>
                                {/* Info */}
                                <div className="flex-1 min-w-0">
                                    <p className="font-semibold text-gray-800 dark:text-white text-sm truncate">{req.userName}</p>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 truncate">
                                        Requested {new Date(req.requestedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}
                                    </p>
                                    {req.requestedRole && (
                                        <span className="inline-block mt-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-0.5 rounded-full">
                                            {({pharmacist:'Pharmacist',act_pharmacist:'ACT Pharmacist',pharmacy_technician:'Pharmacy Technician',dispenser:'Dispenser',counter_assistant:'Counter Assistant',manager:'Manager',trainee_technician:'Trainee Technician',medicines_counter:'Medicines Counter',admin_staff:'Admin Staff',other:'Other'})[req.requestedRole] || req.requestedRole}
                                        </span>
                                    )}
                                </div>
                                {/* Actions */}
                                <div className="flex gap-2 flex-shrink-0">
                                    <button
                                        onClick={() => approveRequest(req)}
                                        className="px-3 py-1.5 rounded-lg text-xs font-semibold text-white transition-colors"
                                        style={{background:'linear-gradient(135deg,#009639,#00B84A)'}}
                                    >
                                        Approve
                                    </button>
                                    <button
                                        onClick={() => denyRequest(req)}
                                        className="px-3 py-1.5 rounded-lg text-xs font-semibold text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                    >
                                        Deny
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {/* Member list */}
                <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
                    {members.length === 0 ? (
                        <div className="p-10 text-center">
                            <p className="text-gray-500 dark:text-gray-400">No team members yet.</p>
                        </div>
                    ) : (
                        members.map((m, idx) => {
                            const u             = getMemberUser(m);
                            const isMe          = m.userId === user.id;
                            const isMemberAdmin = currentBranch?.admins?.includes(m.userId) || false;
                            const rc            = getRoleConfig(m.role);
                            const isLastAdmin   = isMemberAdmin && (currentBranch?.admins?.length || 0) === 1;

                            return (
                                <div key={m.userId} className={`flex items-center gap-3 px-4 py-3 ${idx < members.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : ''}`}>
                                    {/* Avatar */}
                                    <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                                        style={{background:'linear-gradient(135deg,#003087,#005EB8)'}}>
                                        {(u?.name || 'U').charAt(0).toUpperCase()}
                                    </div>

                                    {/* Info */}
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <p className="font-semibold text-gray-800 dark:text-white text-sm truncate">
                                                {u?.name || 'Unknown User'}
                                                {isMe && <span className="ml-1 text-xs text-gray-400 dark:text-gray-500">(you)</span>}
                                            </p>
                                            <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${rc.badge}`}>
                                                {rc.label}
                                            </span>
                                            {isMemberAdmin && (
                                                <span className="text-xs px-2 py-0.5 rounded-full font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 flex items-center gap-1">
                                                    <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm0 2h14v2H5v-2z"/></svg>
                                                    Admin
                                                </span>
                                            )}
                                        </div>
                                        <p className="text-xs text-gray-400 dark:text-gray-500 truncate">
                                            Joined {formatJoined(m.joinedAt)}
                                        </p>
                                    </div>

                                    {/* Admin actions */}
                                    {isAdmin && !isMe && (
                                        <div className="flex items-center gap-1 flex-shrink-0">
                                            {/* Job role picker button */}
                                            <button
                                                onClick={() => setRolePickerMember(m)}
                                                className="p-1.5 rounded-lg text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
                                                title="Change job role"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2" />
                                                </svg>
                                            </button>
                                            {/* Admin toggle */}
                                            {!isLastAdmin && (
                                                <button
                                                    onClick={() => setConfirmAdmin({ member: m, user: u, makeAdmin: !isMemberAdmin })}
                                                    className={`p-1.5 rounded-lg transition-colors ${isMemberAdmin ? 'text-purple-500 hover:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700' : 'text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20'}`}
                                                    title={isMemberAdmin ? 'Remove admin access' : 'Grant admin access'}
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                                    </svg>
                                                </button>
                                            )}
                                            {/* Remove */}
                                            {!isLastAdmin && (
                                                <button
                                                    onClick={() => setConfirmRemove({ member: m, user: u })}
                                                    className="p-1.5 rounded-lg text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                                    title="Remove from branch"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />
                                                    </svg>
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                </div>

                {/* Invite modal — shows branch ID to share */}
                {showInvite && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowInvite(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Invite Staff</h3>
                                <button onClick={() => setShowInvite(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <div className="p-5 space-y-4">
                                <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 text-center">
                                    <p className="text-xs text-blue-600 dark:text-blue-400 font-medium mb-1">Share this Branch ID</p>
                                    <p className="text-2xl font-bold font-mono text-blue-700 dark:text-blue-300 tracking-widest">{branchId}</p>
                                    <p className="text-xs text-blue-500 dark:text-blue-400 mt-2">Staff enter this when they sign up or log in to join your branch</p>
                                </div>
                                <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-3 flex items-start gap-2">
                                    <svg className="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" /></svg>
                                    <p className="text-xs text-amber-700 dark:text-amber-400">Only share this with verified staff members of your pharmacy.</p>
                                </div>
                                <button onClick={() => setShowInvite(false)} className="w-full btn-primary py-3 rounded-xl font-semibold">Done</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Confirm remove modal */}
                {confirmRemove && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setConfirmRemove(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="p-5">
                                <div className="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" /></svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white text-center mb-1">Remove Staff Member?</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-5">
                                    <span className="font-semibold text-gray-700 dark:text-gray-300">{confirmRemove.user?.name}</span> will be removed from {currentBranch?.name}. They will lose access immediately.
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmRemove(null)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button onClick={() => handleRemove(confirmRemove.member.userId)} className="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Job role picker sheet */}
                {rolePickerMember && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setRolePickerMember(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between px-5 pt-5 pb-3 border-b border-gray-100 dark:border-gray-700">
                                <div>
                                    <h3 className="text-lg font-bold text-gray-800 dark:text-white">Set Job Role</h3>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{getMemberUser(rolePickerMember)?.name}</p>
                                </div>
                                <button onClick={() => setRolePickerMember(null)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <div className="p-3 max-h-[60vh] overflow-y-auto">
                                <div className="grid grid-cols-1 gap-1">
                                    {JOB_ROLES.map(jr => {
                                        const isCurrent = rolePickerMember.role === jr.value;
                                        return (
                                            <button
                                                key={jr.value}
                                                onClick={() => {
                                                    if (!isCurrent) setConfirmRole({ member: rolePickerMember, user: getMemberUser(rolePickerMember), newJobRole: jr.value, newJobLabel: jr.label });
                                                    setRolePickerMember(null);
                                                }}
                                                className={`flex items-center justify-between px-4 py-3 rounded-xl transition-colors text-left ${isCurrent ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50'}`}
                                            >
                                                <span className="font-medium text-gray-800 dark:text-white text-sm">{jr.label}</span>
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${jr.badge}`}>{jr.label}</span>
                                                    {isCurrent && (
                                                        <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" /></svg>
                                                    )}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Confirm job role change */}
                {confirmRole && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setConfirmRole(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="p-5">
                                <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2" /></svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white text-center mb-1">Change Job Role?</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-5">
                                    Set <span className="font-semibold text-gray-700 dark:text-gray-300">{confirmRole.user?.name}</span> as <span className="font-semibold text-gray-700 dark:text-gray-300">{confirmRole.newJobLabel}</span>?
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmRole(null)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button onClick={() => handleRoleChange(confirmRole.member.userId, confirmRole.newJobRole)} className="flex-1 btn-primary py-3 rounded-xl font-semibold">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Confirm admin toggle */}
                {confirmAdmin && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setConfirmAdmin(null)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="p-5">
                                <div className={`w-12 h-12 ${confirmAdmin.makeAdmin ? 'bg-purple-100 dark:bg-purple-900/30' : 'bg-red-100 dark:bg-red-900/30'} rounded-full flex items-center justify-center mx-auto mb-4`}>
                                    <svg className={`w-6 h-6 ${confirmAdmin.makeAdmin ? 'text-purple-500' : 'text-red-500'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                    </svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white text-center mb-1">
                                    {confirmAdmin.makeAdmin ? 'Grant Admin Access?' : 'Remove Admin Access?'}
                                </h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-2">
                                    <span className="font-semibold text-gray-700 dark:text-gray-300">{confirmAdmin.user?.name}</span>
                                </p>
                                {confirmAdmin.makeAdmin
                                    ? <p className="text-xs text-amber-600 dark:text-amber-400 text-center mb-5">They will have full admin access to this branch — tasks, staff, settings and more.</p>
                                    : <p className="text-xs text-red-500 dark:text-red-400 text-center mb-5">Their job role will remain unchanged. They will lose admin privileges immediately.</p>
                                }
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmAdmin(null)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                                    <button
                                        onClick={() => handleAdminToggle(confirmAdmin.member.userId, confirmAdmin.makeAdmin)}
                                        className={`flex-1 py-3 rounded-xl font-semibold text-white ${confirmAdmin.makeAdmin ? 'bg-purple-500 hover:bg-purple-600' : 'bg-red-500 hover:bg-red-600'} transition-colors`}
                                    >
                                        {confirmAdmin.makeAdmin ? 'Grant Access' : 'Remove Access'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── SETTINGS TAB ──────────────────────────────────────────────────────────
    function SettingsTab({ user, branch, isAdmin, darkMode, setDarkMode, onLogout, setCurrentUser }) {
        const branchId = branch?.id;

        // Profile edit state
        const [editProfile,  setEditProfile]  = useState(false);
        const [editName,     setEditName]      = useState(user.name);
        const [editEmail,    setEditEmail]     = useState(user.email);
        const [currentPw,    setCurrentPw]     = useState('');
        const [profileError, setProfileError]  = useState('');
        const [profileOk,    setProfileOk]     = useState('');

        // Change password state
        const [changePw,     setChangePw]      = useState(false);
        const [oldPw,        setOldPw]         = useState('');
        const [newPw,        setNewPw]         = useState('');
        const [confirmPw,    setConfirmPw]      = useState('');
        const [pwError,      setPwError]        = useState('');
        const [pwOk,         setPwOk]           = useState('');

        // Branch edit state
        const [editBranch,   setEditBranch]     = useState(false);
        const [newBranchName, setNewBranchName] = useState(branch?.name || '');
        const [branchError,  setBranchError]    = useState('');

        // Legal modals
        const [showPrivacy,  setShowPrivacy]    = useState(false);
        const [showTerms,    setShowTerms]       = useState(false);

        // Danger zone
        const [showLeave,    setShowLeave]       = useState(false);
        const [showDelete,   setShowDelete]      = useState(false);
        const [dangerPw,     setDangerPw]        = useState('');
        const [dangerError,  setDangerError]     = useState('');

        const saveProfile = (e) => {
            e.preventDefault();
            setProfileError(''); setProfileOk('');
            if (!editName.trim())    { setProfileError('Name cannot be empty'); return; }
            if (!editEmail.includes('@')) { setProfileError('Valid email required'); return; }
            if (!currentPw)          { setProfileError('Enter your current password to save changes'); return; }
            const users   = Storage.get('users') || [];
            const idx     = users.findIndex(u => u.id === user.id);
            if (idx === -1)          { setProfileError('User not found'); return; }
            if (users[idx].password !== currentPw) { setProfileError('Current password is incorrect'); return; }
            const emailConflict = users.find(u => u.email.toLowerCase() === editEmail.toLowerCase() && u.id !== user.id);
            if (emailConflict)       { setProfileError('That email is already in use'); return; }
            users[idx] = { ...users[idx], name: editName.trim(), email: editEmail.trim() };
            Storage.set('users', users);
            const updated = { ...user, name: editName.trim(), email: editEmail.trim() };
            Storage.set('rememberedUser', updated);
            setCurrentUser(updated);
            setCurrentPw('');
            setEditProfile(false);
            setProfileOk('Profile updated successfully');
            setTimeout(() => setProfileOk(''), 3000);
        };

        const savePassword = (e) => {
            e.preventDefault();
            setPwError(''); setPwOk('');
            if (!oldPw)              { setPwError('Enter your current password'); return; }
            if (newPw.length < 8)    { setPwError('New password must be at least 8 characters'); return; }
            if (newPw === oldPw)     { setPwError('New password must be different from your current password'); return; }
            if (newPw !== confirmPw) { setPwError('Passwords do not match'); return; }
            const users = Storage.get('users') || [];
            const idx   = users.findIndex(u => u.id === user.id);
            if (users[idx].password !== oldPw) { setPwError('Current password is incorrect'); return; }
            users[idx] = { ...users[idx], password: newPw };
            Storage.set('users', users);
            setOldPw(''); setNewPw(''); setConfirmPw('');
            setChangePw(false);
            setPwOk('Password changed successfully');
            setTimeout(() => setPwOk(''), 3000);
        };

        const saveBranchName = (e) => {
            e.preventDefault();
            setBranchError('');
            if (!newBranchName.trim()) { setBranchError('Branch name cannot be empty'); return; }
            const branches = Storage.get('branches') || [];
            const updated  = branches.map(b => b.id === branchId ? { ...b, name: newBranchName.trim() } : b);
            Storage.set('branches', updated);
            setEditBranch(false);
        };

        const handleLeave = () => {
            setDangerError('');
            const users = Storage.get('users') || [];
            const idx   = users.findIndex(u => u.id === user.id);
            if (users[idx]?.password !== dangerPw) { setDangerError('Incorrect password'); return; }
            const branches = Storage.get('branches') || [];
            const updated  = branches.map(b => b.id === branchId
                ? { ...b, members: b.members.filter(m => m.userId !== user.id) }
                : b);
            Storage.set('branches', updated);
            users[idx] = { ...users[idx], branchId: null, chainId: null, isAdmin: false };
            Storage.set('users', users);
            Storage.set('rememberedUser', null);
            onLogout();
        };

        const handleDeleteBranch = () => {
            setDangerError('');
            const users = Storage.get('users') || [];
            const idx   = users.findIndex(u => u.id === user.id);
            if (users[idx]?.password !== dangerPw) { setDangerError('Incorrect password'); return; }
            const branches = Storage.get('branches') || [];
            Storage.set('branches', branches.filter(b => b.id !== branchId));
            // Clear all branch members' branchId
            const branchMembers = (branches.find(b => b.id === branchId)?.members || []).map(m => m.userId);
            const updatedUsers  = users.map(u => branchMembers.includes(u.id) ? { ...u, branchId: null, chainId: null, isAdmin: false } : u);
            Storage.set('users', updatedUsers);
            Storage.set('rememberedUser', null);
            onLogout();
        };

        const Section = ({ title, children }) => (
            <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden mb-4">
                <div className="px-4 py-3 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30">
                    <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{title}</h3>
                </div>
                <div>{children}</div>
            </div>
        );

        const Row = ({ label, value, onEdit, children }) => (
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                <div className="flex-1 min-w-0">
                    <p className="text-xs text-gray-400 dark:text-gray-500">{label}</p>
                    {value && <p className="text-sm font-medium text-gray-800 dark:text-white mt-0.5 truncate">{value}</p>}
                    {children}
                </div>
                {onEdit && (
                    <button onClick={onEdit} className="ml-3 text-xs text-blue-600 dark:text-blue-400 hover:underline flex-shrink-0 font-medium">Edit</button>
                )}
            </div>
        );

        return (
            <div className="animate-fadeIn pb-4">
                <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">Settings</h2>

                {/* Success toasts */}
                {(profileOk || pwOk) && (
                    <div className="mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 rounded-xl text-sm flex items-center gap-2">
                        <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        {profileOk || pwOk}
                    </div>
                )}

                {/* Profile */}
                <Section title="Your Profile">
                    <Row label="Display Name" value={user.name} onEdit={() => { setEditProfile(true); setEditName(user.name); setEditEmail(user.email); setCurrentPw(''); setProfileError(''); }} />
                    <Row label="Email" value={user.email} />
                    <Row label="Role" value={isAdmin ? 'Administrator' : 'Staff Member'} />
                    <div className="px-4 py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <button
                            onClick={() => { setChangePw(true); setOldPw(''); setNewPw(''); setConfirmPw(''); setPwError(''); }}
                            className="text-sm text-blue-600 dark:text-blue-400 font-medium hover:underline"
                        >
                            Change Password
                        </button>
                    </div>
                </Section>

                {/* Branch */}
                <Section title="Branch">
                    <Row label="Branch Name" value={branch?.name} onEdit={isAdmin ? () => { setEditBranch(true); setNewBranchName(branch?.name || ''); setBranchError(''); } : null} />
                    <Row label="Branch ID">
                        <p className="text-sm font-mono font-bold text-gray-800 dark:text-white mt-0.5">{branch?.id}</p>
                    </Row>
                    {branch?.chainId && branch.chainId !== 'independent' && (
                        <Row label="Chain" value={branch.chainId} />
                    )}
                    {isAdmin && (
                        <div className="px-4 py-3 bg-blue-50 dark:bg-blue-900/10">
                            <p className="text-xs text-blue-600 dark:text-blue-400">
                                Share Branch ID <span className="font-mono font-bold">{branch?.id}</span> with new staff so they can join your branch.
                            </p>
                        </div>
                    )}
                </Section>

                {/* Appearance */}
                <Section title="Appearance">
                    <div className="flex items-center justify-between px-4 py-3">
                        <div>
                            <p className="text-sm font-medium text-gray-800 dark:text-white">Dark Mode</p>
                            <p className="text-xs text-gray-400 dark:text-gray-500 mt-0.5">Switch between light and dark theme</p>
                        </div>
                        <button
                            onClick={() => setDarkMode(!darkMode)}
                            className={`relative w-12 h-6 rounded-full transition-all duration-300 ${darkMode ? 'bg-blue-600' : 'bg-gray-200 dark:bg-gray-600'}`}
                        >
                            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-all duration-300 ${darkMode ? 'left-6' : 'left-0.5'}`} />
                        </button>
                    </div>
                </Section>

                {/* Legal */}
                <Section title="Legal">
                    {[
                        { label: 'Privacy Policy',  onClick: () => setShowPrivacy(true) },
                        { label: 'Terms of Use',    onClick: () => setShowTerms(true) },
                    ].map(item => (
                        <button key={item.label} onClick={item.onClick} className="w-full flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors text-left">
                            <span className="text-sm font-medium text-gray-700 dark:text-gray-300">{item.label}</span>
                            <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                        </button>
                    ))}
                </Section>

                {/* Danger zone */}
                <div className="bg-white dark:bg-gray-800 rounded-2xl border border-red-100 dark:border-red-900/30 shadow-sm overflow-hidden mb-4">
                    <div className="px-4 py-3 border-b border-red-100 dark:border-red-900/30 bg-red-50 dark:bg-red-900/10">
                        <h3 className="text-xs font-semibold text-red-500 uppercase tracking-wider">Danger Zone</h3>
                    </div>
                    {!isAdmin ? (
                        <button onClick={() => { setShowLeave(true); setDangerPw(''); setDangerError(''); }} className="w-full px-4 py-3 text-left text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors">
                            Leave Branch
                        </button>
                    ) : (
                        <button onClick={() => { setShowDelete(true); setDangerPw(''); setDangerError(''); }} className="w-full px-4 py-3 text-left text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors">
                            Delete Branch
                        </button>
                    )}
                </div>

                {/* ── EDIT PROFILE MODAL ── */}
                {editProfile && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setEditProfile(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Edit Profile</h3>
                                <button onClick={() => setEditProfile(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                            </div>
                            <form onSubmit={saveProfile} className="p-5 space-y-4">
                                {profileError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{profileError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Display Name</label>
                                    <input type="text" value={editName} onChange={e => setEditName(e.target.value)} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Email</label>
                                    <input type="email" value={editEmail} onChange={e => setEditEmail(e.target.value)} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Current Password *</label>
                                    <input type="password" value={currentPw} onChange={e => setCurrentPw(e.target.value)} className="input-field" placeholder="Required to save changes" />
                                </div>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setEditProfile(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* ── CHANGE PASSWORD MODAL ── */}
                {changePw && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setChangePw(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl animate-slideUp" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Change Password</h3>
                                <button onClick={() => setChangePw(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                            </div>
                            <form onSubmit={savePassword} className="p-5 space-y-4">
                                {pwError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{pwError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Current Password</label>
                                    <input type="password" value={oldPw} onChange={e => setOldPw(e.target.value)} className="input-field" placeholder="••••••••" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">New Password</label>
                                    <input type="password" value={newPw} onChange={e => setNewPw(e.target.value)} className="input-field" placeholder="8+ characters" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Confirm New Password</label>
                                    <input type="password" value={confirmPw} onChange={e => setConfirmPw(e.target.value)} className="input-field" placeholder="••••••••" />
                                </div>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setChangePw(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Change</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* ── EDIT BRANCH NAME MODAL ── */}
                {editBranch && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setEditBranch(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Edit Branch Name</h3>
                                <button onClick={() => setEditBranch(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                            </div>
                            <form onSubmit={saveBranchName} className="p-5 space-y-4">
                                {branchError && <div className="p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-sm">{branchError}</div>}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Branch Name</label>
                                    <input type="text" value={newBranchName} onChange={e => setNewBranchName(e.target.value)} className="input-field" autoFocus />
                                </div>
                                <div className="flex gap-3">
                                    <button type="button" onClick={() => setEditBranch(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                                    <button type="submit" className="flex-1 btn-primary py-3 rounded-xl font-semibold">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* ── PRIVACY POLICY MODAL ── */}
                {showPrivacy && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowPrivacy(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg shadow-2xl animate-slideUp max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Privacy Policy</h3>
                                <button onClick={() => setShowPrivacy(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                            </div>
                            <div className="overflow-y-auto p-5 text-sm text-gray-600 dark:text-gray-300 space-y-4 leading-relaxed">
                                <p className="text-xs text-gray-400 italic">Last updated: {new Date().toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' })} · This is placeholder text. Please seek legal advice before deploying this application in a production environment.</p>
                                {[
                                    { title: '1. Data We Collect', body: 'We collect your name, email address, and any information you voluntarily provide when using this application, including messages, tasks, and handover notes created within the platform.' },
                                    { title: '2. How We Use Your Data', body: 'Your data is used solely to provide the functionality of this pharmacy management application. We do not sell or share your personal data with third parties.' },
                                    { title: '3. Data Storage', body: 'All data is stored locally on your device using browser storage (localStorage). No data is transmitted to external servers by this application.' },
                                    { title: '4. Patient Confidentiality', body: 'This platform is not designed to store patient-identifiable information. Users must not enter patient names, NHS numbers, addresses, dates of birth, or any other patient data into this system. Doing so may constitute a breach of GDPR and NHS data protection guidelines.' },
                                    { title: '5. Your Rights', body: 'You have the right to access, correct, or delete your personal data at any time. To exercise these rights, contact your branch administrator.' },
                                    { title: '6. Contact', body: 'For any data protection queries, please contact your branch administrator or designated Data Protection Officer.' },
                                ].map(s => <div key={s.title}><p className="font-semibold text-gray-800 dark:text-white mb-1">{s.title}</p><p>{s.body}</p></div>)}
                            </div>
                            <div className="p-4 border-t border-gray-100 dark:border-gray-700 flex-shrink-0">
                                <button onClick={() => setShowPrivacy(false)} className="w-full btn-primary py-3 rounded-xl font-semibold">Close</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* ── TERMS OF USE MODAL ── */}
                {showTerms && (
                    <div className="fixed inset-0 bg-black/60 flex items-end sm:items-center justify-center z-50 p-4" onClick={() => setShowTerms(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg shadow-2xl animate-slideUp max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700 flex-shrink-0">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Terms of Use</h3>
                                <button onClick={() => setShowTerms(false)} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
                            </div>
                            <div className="overflow-y-auto p-5 text-sm text-gray-600 dark:text-gray-300 space-y-4 leading-relaxed">
                                <p className="text-xs text-gray-400 italic">Last updated: {new Date().toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' })} · This is placeholder text. Please seek legal advice before deploying this application in a production environment.</p>
                                {[
                                    { title: '1. Acceptance of Terms', body: 'By accessing and using this application, you agree to be bound by these Terms of Use. If you do not agree, you must discontinue use immediately.' },
                                    { title: '2. Authorised Use', body: 'This application is intended for use by authorised pharmacy staff only. Access credentials must not be shared. You are responsible for all activity under your account.' },
                                    { title: '3. Prohibited Activities', body: 'Users must not enter patient-identifiable information into this system, attempt to gain unauthorised access, use the platform for any unlawful purpose, or share their login credentials with unauthorised individuals.' },
                                    { title: '4. Professional Responsibility', body: 'This tool is a workflow aid only. It does not replace professional judgement, clinical decision-making, or statutory obligations. Users remain solely responsible for all professional decisions made in their capacity as healthcare professionals.' },
                                    { title: '5. Data Accuracy', body: 'Users are responsible for the accuracy of information they enter. The platform operators accept no liability for errors arising from incorrect data entry.' },
                                    { title: '6. Amendments', body: 'These terms may be updated periodically. Continued use of the application following any changes constitutes acceptance of the revised terms.' },
                                ].map(s => <div key={s.title}><p className="font-semibold text-gray-800 dark:text-white mb-1">{s.title}</p><p>{s.body}</p></div>)}
                            </div>
                            <div className="p-4 border-t border-gray-100 dark:border-gray-700 flex-shrink-0">
                                <button onClick={() => setShowTerms(false)} className="w-full btn-primary py-3 rounded-xl font-semibold">Close</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* ── LEAVE BRANCH MODAL ── */}
                {showLeave && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowLeave(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="p-5">
                                <div className="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white text-center mb-1">Leave Branch?</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">You will lose access to <span className="font-semibold text-gray-700 dark:text-gray-300">{branch?.name}</span> immediately. Enter your password to confirm.</p>
                                {dangerError && <div className="mb-3 p-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-xs">{dangerError}</div>}
                                <input type="password" value={dangerPw} onChange={e => setDangerPw(e.target.value)} className="input-field mb-4" placeholder="Your password" />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowLeave(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium">Cancel</button>
                                    <button onClick={handleLeave} className="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold">Leave</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* ── DELETE BRANCH MODAL ── */}
                {showDelete && (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowDelete(false)}>
                        <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm shadow-2xl animate-scaleIn" onClick={e => e.stopPropagation()}>
                            <div className="p-5">
                                <div className="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg className="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-800 dark:text-white text-center mb-1">Delete Branch?</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">This will permanently delete <span className="font-semibold text-gray-700 dark:text-gray-300">{branch?.name}</span> and remove all members. This cannot be undone. Enter your password to confirm.</p>
                                {dangerError && <div className="mb-3 p-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-lg text-xs">{dangerError}</div>}
                                <input type="password" value={dangerPw} onChange={e => setDangerPw(e.target.value)} className="input-field mb-4" placeholder="Your password" />
                                <div className="flex gap-3">
                                    <button onClick={() => setShowDelete(false)} className="flex-1 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium">Cancel</button>
                                    <button onClick={handleDeleteBranch} className="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // ─── INSIGHTS TAB ──────────────────────────────────────────────────────────
    function InsightsTab({ user, branch }) {
        const branchId = branch?.id;

        // Load all data
        const tasks     = Storage.get(`tasks_${branchId}`)    || [];
        const messages  = Storage.get(`messages_${branchId}`) || [];
        const handovers = Storage.get(`handover_${branchId}`) || [];
        const members   = branch?.members || [];
        const channels  = Storage.get(`channels_${branchId}`) || [];

        // All channel messages combined
        const allMessages = channels.reduce((acc, ch) => {
            const msgs = Storage.get(`msgs_${branchId}_${ch.id}`) || [];
            return [...acc, ...msgs];
        }, [...messages]);

        // Date helpers
        const now       = new Date();
        const startOfWeek = new Date(now);
        const dow = now.getDay();
        startOfWeek.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1));
        startOfWeek.setHours(0,0,0,0);

        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        const isThisWeek  = (iso) => new Date(iso) >= startOfWeek;
        const isThisMonth = (iso) => new Date(iso) >= startOfMonth;

        // Task stats
        const tasksThisWeek       = tasks.filter(t => isThisWeek(t.createdAt));
        const tasksThisMonth      = tasks.filter(t => isThisMonth(t.createdAt));
        const completedThisWeek   = tasks.filter(t => t.completed && t.completedAt && isThisWeek(t.completedAt));
        const completedThisMonth  = tasks.filter(t => t.completed && t.completedAt && isThisMonth(t.completedAt));
        const overdueTasks        = tasks.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < now);
        const highPriorityOpen    = tasks.filter(t => !t.completed && t.priority === 'high');

        // Message stats
        const msgsThisWeek  = allMessages.filter(m => isThisWeek(m.timestamp));
        const msgsThisMonth = allMessages.filter(m => isThisMonth(m.timestamp));

        // Handover stats
        const handoversThisWeek  = handovers.filter(h => isThisWeek(h.createdAt));
        const urgentHandovers    = handovers.filter(h => h.priority === 'urgent');

        // Top task creators (all time)
        const creatorMap = {};
        tasks.forEach(t => {
            if (!t.createdByName) return;
            creatorMap[t.createdByName] = (creatorMap[t.createdByName] || 0) + 1;
        });
        const topCreators = Object.entries(creatorMap)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 5);
        const maxCreator = topCreators[0]?.[1] || 1;

        // Tasks by priority breakdown
        const byPriority = [
            { label: 'High',   count: tasks.filter(t => t.priority === 'high').length,   color: 'bg-red-500' },
            { label: 'Medium', count: tasks.filter(t => t.priority === 'medium').length, color: 'bg-amber-400' },
            { label: 'Low',    count: tasks.filter(t => t.priority === 'low').length,    color: 'bg-green-500' },
        ];
        const maxPriority = Math.max(...byPriority.map(p => p.count), 1);

        // Messages per day this week (Mon–today)
        const dayLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const msgsByDay = dayLabels.map((label, i) => {
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            const next = new Date(d); next.setDate(d.getDate() + 1);
            const count = allMessages.filter(m => {
                const t = new Date(m.timestamp);
                return t >= d && t < next;
            }).length;
            return { label, count };
        });
        const maxMsgDay = Math.max(...msgsByDay.map(d => d.count), 1);

        // Handover shift breakdown
        const shiftBreakdown = [
            { label: '🌅 Morning',   count: handovers.filter(h => h.shift === 'morning').length },
            { label: '☀️ Afternoon', count: handovers.filter(h => h.shift === 'afternoon').length },
            { label: '🌙 Night',     count: handovers.filter(h => h.shift === 'night').length },
        ];
        const maxShift = Math.max(...shiftBreakdown.map(s => s.count), 1);

        const StatCard = ({ label, value, sub, color, icon }) => (
            <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm p-4">
                <div className="flex items-start justify-between">
                    <div>
                        <p className="text-xs text-gray-500 dark:text-gray-400 font-medium">{label}</p>
                        <p className={`text-3xl font-bold mt-1 ${color || 'text-gray-800 dark:text-white'}`}>{value}</p>
                        {sub && <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{sub}</p>}
                    </div>
                    <div className="text-2xl">{icon}</div>
                </div>
            </div>
        );

        const BarChart = ({ data, maxVal, colorClass, height = 'h-24' }) => (
            <div className={`flex items-end gap-1.5 ${height} w-full`}>
                {data.map((d, i) => (
                    <div key={i} className="flex-1 flex flex-col items-center gap-1 h-full justify-end">
                        <span className="text-xs font-semibold text-gray-600 dark:text-gray-400">{d.count > 0 ? d.count : ''}</span>
                        <div
                            className={`w-full rounded-t-lg transition-all ${colorClass} min-h-[4px]`}
                            style={{ height: `${Math.max((d.count / maxVal) * 80, d.count > 0 ? 8 : 4)}%` }}
                        />
                        <span className="text-xs text-gray-400 dark:text-gray-500 truncate w-full text-center">{d.label}</span>
                    </div>
                ))}
            </div>
        );

        const Section = ({ title, children }) => (
            <div className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden mb-4">
                <div className="px-4 py-3 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30">
                    <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">{title}</h3>
                </div>
                <div className="p-4">{children}</div>
            </div>
        );

        return (
            <div className="space-y-4 animate-fadeIn">

                {/* Header */}
                <div>
                    <h2 className="text-xl font-bold text-gray-800 dark:text-white">Insights</h2>
                    <p className="text-xs text-gray-500 dark:text-gray-400">{branch?.name} · Admin view</p>
                </div>

                {/* Key stats grid */}
                <div className="grid grid-cols-2 gap-3">
                    <StatCard label="Tasks This Week"  value={tasksThisWeek.length}      sub={`${completedThisWeek.length} completed`}   color="text-blue-600 dark:text-blue-400"   icon="📋" />
                    <StatCard label="Tasks This Month" value={tasksThisMonth.length}     sub={`${completedThisMonth.length} completed`}  color="text-purple-600 dark:text-purple-400" icon="✅" />
                    <StatCard label="Messages (Week)"  value={msgsThisWeek.length}       sub={`${msgsThisMonth.length} this month`}      color="text-green-600 dark:text-green-400"  icon="💬" />
                    <StatCard label="Active Staff"     value={members.length}            sub={`${branch?.admins?.length || 0} admin`} color="text-amber-600 dark:text-amber-400" icon="👥" />
                    <StatCard label="Handovers (Week)" value={handoversThisWeek.length}  sub={`${urgentHandovers.length} urgent total`}  color="text-red-600 dark:text-red-400"     icon="📝" />
                    <StatCard label="Overdue Tasks"    value={overdueTasks.length}       sub={`${highPriorityOpen.length} high priority open`} color={overdueTasks.length > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'} icon="⚠️" />
                </div>

                {/* Messages per day this week */}
                <Section title="Messages Per Day · This Week">
                    {allMessages.length === 0 ? (
                        <p className="text-sm text-gray-400 dark:text-gray-500 text-center py-4">No messages yet</p>
                    ) : (
                        <BarChart data={msgsByDay} maxVal={maxMsgDay} colorClass="bg-blue-400 dark:bg-blue-500" height="h-32" />
                    )}
                </Section>

                {/* Tasks by priority */}
                <Section title="All Tasks by Priority">
                    {tasks.length === 0 ? (
                        <p className="text-sm text-gray-400 dark:text-gray-500 text-center py-4">No tasks yet</p>
                    ) : (
                        <div className="space-y-3">
                            {byPriority.map(p => (
                                <div key={p.label} className="flex items-center gap-3">
                                    <span className="text-sm text-gray-600 dark:text-gray-400 w-14 font-medium">{p.label}</span>
                                    <div className="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                                        <div
                                            className={`h-3 rounded-full ${p.color} transition-all`}
                                            style={{ width: `${(p.count / maxPriority) * 100}%` }}
                                        />
                                    </div>
                                    <span className="text-sm font-bold text-gray-700 dark:text-gray-300 w-6 text-right">{p.count}</span>
                                </div>
                            ))}
                            <div className="flex justify-between text-xs text-gray-400 dark:text-gray-500 pt-1 border-t border-gray-100 dark:border-gray-700 mt-2">
                                <span>Total tasks: <span className="font-semibold text-gray-600 dark:text-gray-300">{tasks.length}</span></span>
                                <span>Completed: <span className="font-semibold text-green-600 dark:text-green-400">{tasks.filter(t=>t.completed).length}</span></span>
                                <span>Open: <span className="font-semibold text-blue-600 dark:text-blue-400">{tasks.filter(t=>!t.completed).length}</span></span>
                            </div>
                        </div>
                    )}
                </Section>

                {/* Top task creators */}
                {topCreators.length > 0 && (
                    <Section title="Top Task Creators · All Time">
                        <div className="space-y-2.5">
                            {topCreators.map(([name, count], i) => (
                                <div key={name} className="flex items-center gap-3">
                                    <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
                                        style={{background:'linear-gradient(135deg,#003087,#005EB8)'}}>
                                        {i + 1}
                                    </div>
                                    <span className="text-sm text-gray-700 dark:text-gray-300 flex-1 font-medium truncate">{name}</span>
                                    <div className="flex-1 max-w-[120px] bg-gray-100 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                                        <div
                                            className="h-2 rounded-full bg-blue-500 transition-all"
                                            style={{ width: `${(count / maxCreator) * 100}%` }}
                                        />
                                    </div>
                                    <span className="text-sm font-bold text-gray-700 dark:text-gray-300 w-6 text-right">{count}</span>
                                </div>
                            ))}
                        </div>
                    </Section>
                )}

                {/* Handover shift breakdown */}
                <Section title="Handover Notes by Shift">
                    {handovers.length === 0 ? (
                        <p className="text-sm text-gray-400 dark:text-gray-500 text-center py-4">No handover notes yet</p>
                    ) : (
                        <div className="space-y-3">
                            {shiftBreakdown.map(s => (
                                <div key={s.label} className="flex items-center gap-3">
                                    <span className="text-sm text-gray-600 dark:text-gray-400 w-24 font-medium">{s.label}</span>
                                    <div className="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                                        <div
                                            className="h-3 rounded-full bg-purple-400 dark:bg-purple-500 transition-all"
                                            style={{ width: `${(s.count / maxShift) * 100}%` }}
                                        />
                                    </div>
                                    <span className="text-sm font-bold text-gray-700 dark:text-gray-300 w-6 text-right">{s.count}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </Section>

                {/* Branch channels summary */}
                {channels.length > 0 && (
                    <Section title="Channel Activity">
                        <div className="space-y-2">
                            {channels.map(ch => {
                                const chMsgs = Storage.get(`msgs_${branchId}_${ch.id}`) || [];
                                return (
                                    <div key={ch.id} className="flex items-center justify-between py-1">
                                        <span className="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1">
                                            <span className="text-gray-400">#</span>{ch.name}
                                        </span>
                                        <span className="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                            {chMsgs.length} msg{chMsgs.length !== 1 ? 's' : ''}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </Section>
                )}

            </div>
        );
    }

    // ─── BOTTOM NAVIGATION ─────────────────────────────────────────────────────
    function BottomNav({ currentTab, setCurrentTab, isAdmin }) {
        const [showMore, setShowMore] = useState(false);

        const mainTabs = [
            { id: 'dashboard', label: 'Home',     icon: <Icon.Home /> },
            { id: 'tasks',     label: 'Tasks',    icon: <Icon.Tasks /> },
            { id: 'messages',  label: 'Messages', icon: <Icon.Messages /> },
        ];

        const moreTabs = [
            { id: 'handover',  label: 'Handover',  icon: <Icon.Handover /> },
            { id: 'schedule',  label: 'Schedule',  icon: <Icon.Schedule /> },
            { id: 'sops',      label: 'SOPs',      icon: <Icon.SOPs /> },
            { id: 'calendar',  label: 'Calendar',  icon: <Icon.Calendar /> },
            { id: 'notices',   label: 'Notices',   icon: <Icon.Notices /> },
            { id: 'settings',  label: 'Settings',  icon: <Icon.Settings /> },
            { id: 'staff',     label: 'Staff',     icon: <Icon.Staff /> },
        ];

        if (isAdmin) {
            moreTabs.push({ id: 'insights', label: 'Insights', icon: <Icon.Insights /> });
        }

        const isMoreActive = moreTabs.some(t => t.id === currentTab);

        const handleMoreTab = (id) => {
            setCurrentTab(id);
            setShowMore(false);
        };

        return (
            <>
                {/* Backdrop */}
                {showMore && (
                    <div
                        className="fixed inset-0 z-30"
                        onClick={() => setShowMore(false)}
                    />
                )}

                {/* More popup menu */}
                {showMore && (
                    <div className="fixed bottom-20 right-3 z-40 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 py-2 min-w-[180px] animate-scaleIn">
                        {moreTabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => handleMoreTab(tab.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors hover:bg-gray-50 dark:hover:bg-gray-700
                                    ${currentTab === tab.id
                                        ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20'
                                        : 'text-gray-700 dark:text-gray-300'
                                    }`}
                            >
                                <span className={currentTab === tab.id ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}>
                                    {tab.icon}
                                </span>
                                {tab.label}
                                {currentTab === tab.id && (
                                    <span className="ml-auto w-2 h-2 rounded-full bg-blue-600 dark:bg-blue-400" />
                                )}
                            </button>
                        ))}
                    </div>
                )}

                {/* Bottom bar */}
                <div className="fixed bottom-0 left-0 right-0 z-20 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg">
                    <div className="max-w-2xl mx-auto flex justify-around items-center px-2 py-1">
                        {mainTabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => { setCurrentTab(tab.id); setShowMore(false); }}
                                className={`flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all
                                    ${currentTab === tab.id
                                        ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 scale-105'
                                        : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                                    }`}
                            >
                                {tab.icon}
                                <span className="text-xs font-medium">{tab.label}</span>
                            </button>
                        ))}

                        {/* More button */}
                        <button
                            onClick={() => setShowMore(!showMore)}
                            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-all
                                ${isMoreActive || showMore
                                    ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 scale-105'
                                    : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                                }`}
                        >
                            <Icon.More />
                            <span className="text-xs font-medium">More</span>
                        </button>
                    </div>
                </div>
            </>
        );
    }

    // ─── MAIN APP ──────────────────────────────────────────────────────────────
    function MainApp({ user, onLogout, darkMode, setDarkMode, setCurrentUser }) {
        const [currentTab, setCurrentTab] = useState('dashboard');

        const branches = Storage.get('branches') || [];
        const branch   = branches.find(b => b.id === user.branchId);
        const isAdmin  = branch?.admins?.includes(user.id) || false;

        // Unseen task reports — admin notification
        const unseenReports = isAdmin
            ? (Storage.get(`reports_${user.branchId}`) || []).filter(r => !r.seen).length
            : 0;

        const renderTab = () => {
            switch (currentTab) {
                case 'dashboard': return <DashboardTab user={user} branch={branch} isAdmin={isAdmin} setCurrentTab={setCurrentTab} />;
                case 'tasks':     return <TasksTab user={user} branch={branch} isAdmin={isAdmin} unseenReports={unseenReports} />;
                case 'messages':  return <MessagesTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'handover':  return <HandoverTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'schedule':  return <ScheduleTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'sops':      return <PlaceholderTab icon={<Icon.SOPs />}     title="SOPs"       description="Standard operating procedures for your branch." />;
                case 'calendar':  return <CalendarTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'notices':   return <NoticesTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'settings':  return <SettingsTab user={user} branch={branch} isAdmin={isAdmin} darkMode={darkMode} setDarkMode={setDarkMode} onLogout={onLogout} setCurrentUser={setCurrentUser} />;
                case 'staff':     return <StaffTab user={user} branch={branch} isAdmin={isAdmin} />;
                case 'insights':  return <InsightsTab user={user} branch={branch} />;
                default:          return <PlaceholderTab icon={<Icon.Home />}     title="Dashboard"  description="Your overview and quick actions will appear here." />;
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">

                    {/* ── TOP HEADER ── */}
                    <div className="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm">
                        <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-9 h-9 rounded-xl flex items-center justify-center text-white shadow-sm flex-shrink-0" style={{background: 'linear-gradient(135deg, #003087 0%, #005EB8 100%)'}}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                    </svg>
                                </div>
                                <div>
                                    <h1 className="text-sm font-bold text-gray-800 dark:text-white leading-tight">
                                        {branch?.name || 'Pharmacy Manager'}
                                    </h1>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 leading-tight">
                                        {user.name} &bull; {isAdmin ? 'Admin' : 'Staff'}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                                >
                                    {darkMode ? <Icon.Sun /> : <Icon.Moon />}
                                </button>
                                <button
                                    onClick={onLogout}
                                    className="px-3 py-1.5 rounded-lg text-sm font-medium text-white transition-all hover:opacity-90"
                                    style={{background: '#DA291C'}}
                                >
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* ── TAB CONTENT ── */}
                    <div className="max-w-2xl mx-auto p-4">
                        {renderTab()}
                    </div>

                    {/* ── BOTTOM NAV ── */}
                    <BottomNav
                        currentTab={currentTab}
                        setCurrentTab={setCurrentTab}
                        isAdmin={isAdmin}
                    />
                </div>
        );
    }

    // ─── ROOT APP ──────────────────────────────────────────────────────────────
    function PharmacyApp() {
        const [darkMode, setDarkMode]       = useState(() => {
            const saved = Storage.get('darkMode') || false;
            if (saved) document.documentElement.classList.add('dark');
            return saved;
        });
        const [currentUser, setCurrentUser] = useState(null);
        const [screen, setScreen]           = useState('login');

        useEffect(() => {
            Storage.set('darkMode', darkMode);
            document.documentElement.classList.toggle('dark', darkMode);
        }, [darkMode]);

        useEffect(() => {
            const remembered = Storage.get('rememberedUser');
            if (remembered) {
                setCurrentUser(remembered);
                setScreen(remembered.branchId ? 'app' : 'branch');
            }
        }, []);

        const handleLogin = (user) => {
            setCurrentUser(user);
            setScreen(user.branchId ? 'app' : 'branch');
        };

        const handleBranchComplete = (updatedUser) => {
            setCurrentUser(updatedUser);
            setScreen('app');
        };

        const handleLogout = () => {
            Storage.remove('rememberedUser');
            setCurrentUser(null);
            setScreen('login');
        };

        if (screen === 'login')  return <AuthScreen   onLogin={handleLogin}                          darkMode={darkMode} setDarkMode={setDarkMode} />;
        if (screen === 'branch') return <BranchScreen user={currentUser} onComplete={handleBranchComplete} onBack={() => { Storage.set('rememberedUser', null); setCurrentUser(null); setScreen('login'); }} darkMode={darkMode} />;
        return                          <MainApp      user={currentUser} onLogout={handleLogout}     darkMode={darkMode} setDarkMode={setDarkMode} setCurrentUser={setCurrentUser} />;
    }

    ReactDOM.render(<PharmacyApp />, document.getElementById('root'));
</script>
</body>
</html>
